<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WCTV AI Deployment Analyzer</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sora:wght@700;800&display=swap" rel="stylesheet">
<style>
:root {
  /* WCTV Brand Colors */
  --navy: #1a2d5a;
  --navy-dark: #0f1e3d;
  --lime: #6abf1e;
  --lime-dark: #4a8a12;
  --lime-light: rgba(106,191,30,0.12);
  --lime-xlight: rgba(106,191,30,0.06);

  /* UI Colors */
  --bg: #f2f5f9;
  --surface: #ffffff;
  --border: #dde3ed;
  --border-light: #edf0f5;
  --ink: #1a2d5a;
  --ink-mid: #3a5080;
  --muted: #7a8fab;

  /* Status Colors */
  --red: #d63031;
  --red-light: rgba(214,48,49,0.08);
  --amber: #e17055;
  --amber-light: rgba(225,112,85,0.08);
  --green: #00b894;
  --green-light: rgba(0,184,148,0.08);
  --blue: #0984e3;
  --blue-light: rgba(9,132,227,0.08);

  --tag-bg: #edf1f7;
  --shadow-sm: 0 1px 3px rgba(26,45,90,0.08);
  --shadow: 0 2px 12px rgba(26,45,90,0.08);
  --shadow-lg: 0 8px 40px rgba(26,45,90,0.14);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'Inter', sans-serif;
  font-size: 13.5px;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* HEADER */
header {
  background: var(--navy);
  color: #fff;
  padding: 0 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  height: 58px;
  box-shadow: 0 2px 16px rgba(26,45,90,0.25);
}
.logo-wrap { display: flex; align-items: center; gap: 14px; }
.logo-dots {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 3px;
  width: 26px; height: 26px;
}
.logo-dots span {
  border-radius: 50%;
  background: var(--lime);
  display: block;
}
.logo-dots span:nth-child(5) { background: #90d94a; }
.logo-dots span:nth-child(2),.logo-dots span:nth-child(4),.logo-dots span:nth-child(6),.logo-dots span:nth-child(8) { background: var(--lime-dark); }
.logo-text { display: flex; flex-direction: column; gap: 1px; }
.logo {
  font-family: 'Sora', sans-serif;
  font-size: 1.1rem;
  font-weight: 800;
  color: #fff;
  letter-spacing: 0.02em;
  line-height: 1;
}
.logo span { color: var(--lime); }
.header-sub { font-size: 0.6rem; color: rgba(255,255,255,0.45); letter-spacing: 0.08em; text-transform: uppercase; margin-top: 2px; }
.header-right { display: flex; align-items: center; gap: 12px; }
.live-badge {
  display: flex; align-items: center; gap: 5px;
  font-size: 0.65rem; color: var(--lime); text-transform: uppercase;
  letter-spacing: 0.08em; font-weight: 600;
}
.live-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--lime); animation: pulse 2s infinite; }
.live-dot.error { background: #ff7675; }
.live-dot.loading { background: #fdcb6e; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.35} }
.data-tag { font-size: 0.62rem; color: rgba(255,255,255,0.38); }
.refresh-btn {
  display: flex; align-items: center; gap: 6px;
  background: rgba(106,191,30,0.15);
  border: 1px solid rgba(106,191,30,0.35);
  color: var(--lime);
  font-family: 'Inter', sans-serif;
  font-size: 0.68rem; font-weight: 600;
  padding: 6px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.refresh-btn:hover { background: rgba(106,191,30,0.25); border-color: var(--lime); }
.refresh-btn:disabled { opacity: 0.35; cursor: not-allowed; }
.refresh-btn .spin { display: inline-block; }
.refresh-btn.loading .spin { animation: spin 1s linear infinite; }
@keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

/* LAYOUT */
.app-body { display: flex; flex: 1; overflow: hidden; }

/* SIDEBAR */
.sidebar {
  width: 252px;
  background: var(--surface);
  display: flex; flex-direction: column; flex-shrink: 0;
  border-right: 1px solid var(--border);
  overflow-y: auto;
}
.sidebar-section { padding: 14px 14px; border-bottom: 1px solid var(--border-light); }
.sidebar-label {
  font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--muted); margin-bottom: 8px; font-weight: 700;
}
.quick-btn {
  display: flex; align-items: flex-start; width: 100%;
  background: transparent;
  border: 1px solid var(--border-light);
  color: var(--ink-mid);
  font-family: 'Inter', sans-serif;
  font-size: 0.72rem; font-weight: 500;
  text-align: left; padding: 8px 10px;
  cursor: pointer; border-radius: 7px;
  margin-bottom: 4px; transition: all 0.15s;
  line-height: 1.4; gap: 8px;
}
.quick-btn:hover { background: var(--lime-xlight); border-color: var(--lime); color: var(--navy); }
.quick-btn .qb-icon { flex-shrink: 0; }

.stat-mini { margin-bottom: 7px; display: flex; justify-content: space-between; align-items: center; }
.stat-mini-label { font-size: 0.69rem; color: var(--muted); font-weight: 500; }
.stat-mini-val { font-size: 0.85rem; font-weight: 700; }
.val-red { color: var(--red); }
.val-amber { color: var(--amber); }
.val-green { color: var(--green); }
.val-blue { color: var(--blue); }

/* LOADING SCREEN */
.loading-screen {
  position: fixed; inset: 0; z-index: 2000;
  background: var(--navy);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 18px;
}
.loading-logo {
  font-family: 'Sora', sans-serif;
  font-size: 2rem; font-weight: 800;
  color: #fff; letter-spacing: 0.02em;
}
.loading-logo span { color: var(--lime); }
.loading-status { font-size: 0.75rem; color: rgba(255,255,255,0.5); }
.loading-bar-wrap { width: 260px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
.loading-bar { height: 100%; width: 0%; background: var(--lime); transition: width 0.4s ease; }
.loading-detail { font-size: 0.65rem; color: rgba(255,255,255,0.35); text-align: center; max-width: 300px; line-height: 1.7; }

/* ERROR SCREEN */
.error-screen {
  position: fixed; inset: 0; z-index: 2000;
  background: var(--navy);
  display: none; flex-direction: column; align-items: center; justify-content: center;
  gap: 14px;
}
.error-icon { font-size: 2.5rem; }
.error-title { font-family: 'Sora', sans-serif; font-size: 1.5rem; color: #fff; font-weight: 700; }
.error-msg { font-size: 0.75rem; color: #ff7675; max-width: 420px; text-align: center; line-height: 1.7; }
.error-detail { font-size: 0.65rem; color: rgba(255,255,255,0.35); max-width: 420px; text-align: center; line-height: 1.7; }
.retry-btn {
  background: var(--lime); border: none; color: var(--navy);
  font-family: 'Inter', sans-serif; font-size: 0.75rem; font-weight: 700;
  padding: 10px 26px; border-radius: 8px; cursor: pointer; margin-top: 6px;
  text-transform: uppercase; letter-spacing: 0.06em; transition: background 0.15s;
}
.retry-btn:hover { background: #7dd422; }

/* MAIN */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); }

/* TABS */
.tabs {
  display: flex;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  padding: 0 8px;
}
.tab {
  padding: 13px 18px;
  font-size: 0.72rem; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.06em;
  cursor: pointer; color: var(--muted);
  border-bottom: 2px solid transparent;
  margin-bottom: -1px; transition: all 0.15s;
  background: none; border-top: none; border-left: none; border-right: none;
  font-family: 'Inter', sans-serif;
}
.tab:hover { color: var(--navy); }
.tab.active { color: var(--navy); border-bottom-color: var(--lime); }

/* MESSAGES */
.messages {
  flex: 1; overflow-y: auto;
  padding: 22px 28px;
  display: flex; flex-direction: column;
  gap: 16px;
}
.msg { display: flex; gap: 10px; animation: msgIn 0.22s ease; max-width: 840px; }
@keyframes msgIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
.msg.user { align-self: flex-end; flex-direction: row-reverse; }
.msg-avatar {
  width: 30px; height: 30px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.72rem; font-weight: 700; flex-shrink: 0; margin-top: 2px;
}
.msg.assistant .msg-avatar { background: var(--navy); color: #fff; }
.msg.user .msg-avatar { background: var(--lime); color: var(--navy); }
.msg-bubble {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 4px 12px 12px 12px;
  padding: 13px 17px;
  font-size: 0.82rem; line-height: 1.75;
  box-shadow: var(--shadow-sm);
  max-width: 700px;
  color: var(--ink);
}
.msg.user .msg-bubble {
  background: var(--navy);
  color: rgba(255,255,255,0.92);
  border-color: var(--navy);
  border-radius: 12px 4px 12px 12px;
}
.msg-bubble strong { color: var(--lime-dark); font-weight: 600; }
.msg.user .msg-bubble strong { color: var(--lime); }
.msg-bubble .section-head {
  font-family: 'Sora', sans-serif;
  font-size: 0.92rem; font-weight: 700;
  color: var(--navy);
  display: block; margin-bottom: 8px;
  border-bottom: 2px solid var(--lime-light);
  padding-bottom: 6px;
}
.msg-bubble ul { margin: 8px 0 8px 16px; }
.msg-bubble li { margin-bottom: 4px; }
.msg-bubble .item-chip {
  display: inline-block; background: var(--tag-bg);
  border: 1px solid var(--border); border-radius: 4px;
  padding: 1px 7px; font-size: 0.69rem; margin: 2px 2px; color: var(--ink);
}
.msg-bubble .urgent-chip { background: var(--red-light); border-color: rgba(214,48,49,0.25); color: var(--red); }
.msg-bubble .ok-chip { background: var(--green-light); border-color: rgba(0,184,148,0.25); color: var(--green); }
.msg-bubble .warn-chip { background: var(--blue-light); border-color: rgba(9,132,227,0.25); color: var(--blue); }
.typing-indicator { display: flex; gap: 4px; padding: 4px 0; align-items: center; }
.typing-dot { width: 6px; height: 6px; background: var(--lime); border-radius: 50%; animation: bounce 1.2s infinite; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-5px)} }

/* BRIEFING */
.briefing-panel { flex: 1; overflow-y: auto; padding: 24px 28px; }
.briefing-header {
  font-family: 'Sora', sans-serif; font-size: 1.7rem; font-weight: 800;
  margin-bottom: 4px; color: var(--navy);
}
.briefing-date { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 24px; font-weight: 500; }
.brief-section { margin-bottom: 26px; }
.brief-section-title {
  font-size: 0.64rem; text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--muted); border-bottom: 1px solid var(--border);
  padding-bottom: 7px; margin-bottom: 12px; font-weight: 700;
}
.brief-card {
  background: var(--surface); border: 1px solid var(--border);
  border-left: 3px solid var(--red);
  padding: 13px 16px; margin-bottom: 8px;
  border-radius: 0 8px 8px 0; box-shadow: var(--shadow-sm);
}
.brief-card.ok-card { border-left-color: var(--green); }
.brief-card.warn-card { border-left-color: var(--amber); }
.brief-card.info-card { border-left-color: var(--blue); }
.brief-card-title { font-size: 0.8rem; font-weight: 600; margin-bottom: 3px; color: var(--navy); }
.brief-card-sub { font-size: 0.71rem; color: var(--muted); line-height: 1.55; }
.brief-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 18px; }
.brief-stat-box {
  background: var(--surface); border: 1px solid var(--border);
  padding: 14px 16px; text-align: center; border-radius: 10px; box-shadow: var(--shadow-sm);
}
.brief-stat-num { font-family: 'Sora', sans-serif; font-size: 2rem; font-weight: 800; line-height: 1; margin-bottom: 4px; }
.brief-stat-lbl { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; }

/* WORKLOAD */
.workload-panel { flex: 1; overflow-y: auto; padding: 24px 28px; }
.person-card {
  background: var(--surface); border: 1px solid var(--border);
  padding: 16px 20px; margin-bottom: 12px;
  box-shadow: var(--shadow-sm); border-radius: 10px;
  animation: msgIn 0.3s ease both;
}
.person-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.person-name { font-family: 'Sora', sans-serif; font-size: 1rem; font-weight: 700; color: var(--navy); }
.person-count { font-size: 0.65rem; padding: 3px 10px; border-radius: 20px; font-weight: 600; }
.overloaded { background: var(--red-light); color: var(--red); border: 1px solid rgba(214,48,49,0.2); }
.busy { background: var(--amber-light); color: #b85c3a; border: 1px solid rgba(225,112,85,0.2); }
.ok-load { background: var(--green-light); color: #007a62; border: 1px solid rgba(0,184,148,0.2); }
.person-tasks { display: flex; flex-wrap: wrap; gap: 5px; }
.person-task-chip {
  font-size: 0.65rem; background: var(--tag-bg);
  border: 1px solid var(--border); padding: 3px 9px;
  border-radius: 5px; color: var(--ink-mid);
}
.person-task-chip.task-high { border-left: 3px solid var(--red); }
.person-task-chip.task-med { border-left: 3px solid var(--amber); }
.load-bar { height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 10px; overflow: hidden; }
.load-fill { height: 100%; border-radius: 2px; transition: width 0.8s ease; }

/* TODAY */
.today-panel { flex: 1; overflow-y: auto; padding: 24px 28px; }
.today-title { font-family: 'Sora', sans-serif; font-size: 1.6rem; font-weight: 800; margin-bottom: 4px; color: var(--navy); }
.today-sub { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 20px; font-weight: 500; }
.today-item {
  display: flex; gap: 14px;
  background: var(--surface); border: 1px solid var(--border);
  padding: 14px 18px; margin-bottom: 8px;
  box-shadow: var(--shadow-sm); border-radius: 10px;
  animation: msgIn 0.3s ease both; align-items: flex-start;
}
.today-num {
  font-family: 'Sora', sans-serif; font-size: 1.5rem; font-weight: 800;
  line-height: 1; color: var(--lime); min-width: 30px; opacity: 0.6;
}
.today-content { flex: 1; }
.today-task-name { font-size: 0.83rem; font-weight: 600; margin-bottom: 4px; color: var(--navy); }
.today-why { font-size: 0.72rem; color: var(--muted); line-height: 1.55; margin-bottom: 8px; }
.today-meta { display: flex; gap: 6px; flex-wrap: wrap; }
.today-tag {
  font-size: 0.62rem; padding: 2px 8px; border-radius: 20px;
  border: 1px solid var(--border); background: var(--tag-bg); color: var(--ink-mid); font-weight: 500;
}
.today-tag.urgent-tag { background: var(--red-light); border-color: rgba(214,48,49,0.25); color: var(--red); }

/* INPUT BAR */
.input-bar {
  background: var(--surface); border-top: 1px solid var(--border);
  padding: 12px 20px; display: flex; gap: 10px; flex-shrink: 0;
}
.input-bar textarea {
  flex: 1; background: var(--bg);
  border: 1px solid var(--border); color: var(--ink);
  font-family: 'Inter', sans-serif; font-size: 0.82rem;
  padding: 10px 14px; border-radius: 8px; resize: none; outline: none;
  transition: border-color 0.2s; max-height: 100px; line-height: 1.5;
}
.input-bar textarea:focus { border-color: var(--lime); box-shadow: 0 0 0 3px var(--lime-light); }
.send-btn {
  background: var(--navy); color: #fff; border: none;
  font-family: 'Inter', sans-serif; font-size: 0.72rem; font-weight: 700;
  padding: 0 22px; cursor: pointer; border-radius: 8px;
  letter-spacing: 0.05em; transition: background 0.15s; text-transform: uppercase;
}
.send-btn:hover { background: var(--lime-dark); }
.send-btn:disabled { opacity: 0.35; cursor: not-allowed; }

/* Scrollbar */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.hidden { display: none !important; }

/* API KEY MODAL */
.apikey-overlay {
  position: fixed; inset: 0; z-index: 1500;
  background: rgba(26,45,90,0.75);
  display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(6px);
  animation: fadeIn 0.2s ease;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes slideUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
.apikey-box {
  background: var(--surface); border: 1px solid var(--border);
  border-top: 3px solid var(--lime);
  padding: 32px 36px; width: 460px;
  box-shadow: var(--shadow-lg); border-radius: 12px;
  animation: slideUp 0.25s ease;
}
.apikey-title { font-family: 'Sora', sans-serif; font-size: 1.3rem; font-weight: 700; margin-bottom: 6px; color: var(--navy); }
.apikey-sub { font-size: 0.72rem; color: var(--muted); margin-bottom: 20px; line-height: 1.65; }
.apikey-input {
  width: 100%; background: var(--bg);
  border: 1px solid var(--border); color: var(--ink);
  font-family: 'Inter', sans-serif; font-size: 0.78rem;
  padding: 10px 14px; border-radius: 8px; outline: none;
  transition: all 0.2s; letter-spacing: 0.02em;
}
.apikey-input:focus { border-color: var(--lime); box-shadow: 0 0 0 3px var(--lime-light); }
.apikey-note { font-size: 0.64rem; color: var(--muted); margin-top: 10px; line-height: 1.6; }
.apikey-note a { color: var(--lime-dark); text-decoration: none; font-weight: 600; }
.apikey-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.apikey-submit {
  background: var(--navy); border: none; color: #fff;
  font-family: 'Inter', sans-serif; font-weight: 700;
  font-size: 0.75rem; padding: 10px 22px; border-radius: 8px; cursor: pointer;
  text-transform: uppercase; letter-spacing: 0.05em; transition: background 0.15s;
}
.apikey-submit:hover { background: var(--lime-dark); }
.apikey-error { font-size: 0.68rem; color: var(--red); margin-top: 8px; min-height: 16px; font-weight: 500; }

/* PLANNER STATUS BANNER */
.planner-banner {
  background: var(--lime-light); border-bottom: 1px solid rgba(106,191,30,0.2);
  padding: 6px 20px; display: flex; align-items: center;
  gap: 8px; font-size: 0.65rem; color: var(--lime-dark);
  flex-shrink: 0; font-weight: 600;
}
.planner-banner.error { background: var(--red-light); border-color: rgba(214,48,49,0.2); color: var(--red); }
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">WC<span>TV</span></div>
  <div style="font-size:0.7rem;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.12em;margin-top:-10px;">Intelligence ¬∑ Deployment Analyzer</div>
  <div class="loading-bar-wrap"><div class="loading-bar" id="loadingBar"></div></div>
  <div class="loading-status" id="loadingStatus">Initializing‚Ä¶</div>
  <div class="loading-detail" id="loadingDetail">Sign in with your WCTV Microsoft 365 account to load live Planner data.</div>
</div>

<!-- API KEY MODAL -->
<div class="apikey-overlay hidden" id="apikeyModal">
  <div class="apikey-box">
    <div class="apikey-title">Enter Claude API Key</div>
    <div class="apikey-sub">Your key is stored only in this browser tab's session memory ‚Äî it's never saved to disk, sent anywhere other than Anthropic's API, or written into the file.</div>
    <input class="apikey-input" id="apikeyInput" type="password" placeholder="sk-ant-..." autocomplete="off" onkeydown="if(event.key==='Enter') submitApiKey()" />
    <div class="apikey-error hidden" id="apikeyError"></div>
    <div class="apikey-note">Get your key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> ‚Üí API Keys. Key is cleared when you close this tab.</div>
    <div class="apikey-actions">
      <button class="apikey-submit" onclick="submitApiKey()">Connect ‚Üí</button>
    </div>
  </div>
</div>

<!-- ERROR SCREEN -->
<div class="error-screen" id="errorScreen">
  <div class="error-icon">‚ö†</div>
  <div class="error-title">Connection Failed</div>
  <div class="error-msg" id="errorMsg">Could not connect to Microsoft Planner.</div>
  <div class="error-detail" id="errorDetail"></div>
  <button class="retry-btn" onclick="initPlanner()">‚Üª Retry</button>
</div>

<header>
  <div class="logo-wrap">
    <div class="logo-dots">
      <span></span><span></span><span></span>
      <span></span><span></span><span></span>
      <span></span><span></span><span></span>
    </div>
    <div class="logo-text">
      <div class="logo">WC<span>TV</span></div>
      <div class="header-sub">Intelligence ¬∑ Deployment Analyzer</div>
    </div>
  </div>
  <div class="header-right">
    <div class="live-badge"><div class="live-dot" id="liveDot"></div> <span id="liveText">Connecting</span></div>
    <div class="data-tag" id="dataTag">Loading‚Ä¶</div>
    <button class="refresh-btn" id="refreshBtn" onclick="refreshData()" disabled>
      <span class="spin">‚Üª</span> Refresh
    </button>
  </div>
</header>

<div class="app-body">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Quick Asks</div>
      <button class="quick-btn" onclick="quickAsk('What are the most critical items my team needs to tackle this week?')"><span class="qb-icon">üî¥</span> This week's critical items</button>
      <button class="quick-btn" onclick="quickAsk('Which items are overdue and what should we do about them?')"><span class="qb-icon">‚ö†Ô∏è</span> Overdue items</button>
      <button class="quick-btn" onclick="quickAsk('Summarize all the MobileCare issues across all clients')"><span class="qb-icon">üì±</span> MobileCare issues</button>
      <button class="quick-btn" onclick="quickAsk('What are the open questions that need answers before we can move forward?')"><span class="qb-icon">‚ùì</span> Open questions</button>
      <button class="quick-btn" onclick="quickAsk('Summarize the status of all CommonSpirit deployments')"><span class="qb-icon">üè•</span> CommonSpirit status</button>
      <button class="quick-btn" onclick="quickAsk('What items are due in Q1 2026 that are not yet started?')"><span class="qb-icon">üìÖ</span> Q1 not started</button>
      <button class="quick-btn" onclick="quickAsk('Which team members appear to have the most active high-priority tasks?')"><span class="qb-icon">üë•</span> Team workload</button>
      <button class="quick-btn" onclick="quickAsk('What items are currently on hold and why?')"><span class="qb-icon">‚è∏Ô∏è</span> On hold items</button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Live Stats</div>
      <div class="stat-mini"><span class="stat-mini-label">Total Tasks</span><span class="stat-mini-val val-blue" id="statTotal">‚Äî</span></div>
      <div class="stat-mini"><span class="stat-mini-label">Overdue</span><span class="stat-mini-val val-red" id="statOverdue">‚Äî</span></div>
      <div class="stat-mini"><span class="stat-mini-label">In Progress</span><span class="stat-mini-val val-blue" id="statInProgress">‚Äî</span></div>
      <div class="stat-mini"><span class="stat-mini-label">Not Started</span><span class="stat-mini-val val-amber" id="statNotStarted">‚Äî</span></div>
      <div class="stat-mini"><span class="stat-mini-label">Completed</span><span class="stat-mini-val val-green" id="statCompleted">‚Äî</span></div>
      <div class="stat-mini"><span class="stat-mini-label">Last Synced</span><span class="stat-mini-val" id="statSync" style="font-size:0.6rem;color:#6a6258">‚Äî</span></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Source</div>
      <div style="font-size:0.62rem;color:#5a5248;line-height:1.6;">
        üìã Plan: <strong style="color:var(--muted)">TO Tasks</strong><br>
        üîó Microsoft Planner Premium<br>
        üîÑ Live via Graph API
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('chat')">üí¨ Chat</button>
      <button class="tab" onclick="switchTab('briefing')">üìã Weekly Briefing</button>
      <button class="tab" onclick="switchTab('workload')">üë• Team Workload</button>
      <button class="tab" onclick="switchTab('today')">‚ö° Tackle Today</button>
    </div>

    <!-- PLANNER STATUS BANNER -->
    <div class="planner-banner hidden" id="plannerBanner"></div>

    <!-- CHAT TAB -->
    <div id="tab-chat" class="messages" style="flex:1;overflow-y:auto;"></div>

    <!-- BRIEFING TAB -->
    <div id="tab-briefing" class="briefing-panel hidden"></div>

    <!-- WORKLOAD TAB -->
    <div id="tab-workload" class="workload-panel hidden"></div>

    <!-- TODAY TAB -->
    <div id="tab-today" class="today-panel hidden"></div>

    <!-- INPUT BAR (only on chat) -->
    <div class="input-bar" id="inputBar">
      <textarea id="chatInput" rows="2" placeholder="Ask anything about your deployment schedule‚Ä¶ e.g. 'What should Aranda focus on today?'" onkeydown="handleKey(event)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send ‚Üë</button>
    </div>
  </div>
</div>

<script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
<script>
// ============================================================
// CONFIG ‚Äî MSAL Interactive Login
// ============================================================
const CONFIG = {
  tenantId:  'd8f88823-0039-4089-a3b1-5b76a6ab42aa',
  clientId:  '13644d21-1490-40cf-bae2-b37d32531682',
  planName:  'TO Tasks',
};

const GRAPH = 'https://graph.microsoft.com/v1.0';

const msalConfig = {
  auth: {
    clientId:  CONFIG.clientId,
    authority: `https://login.microsoftonline.com/${CONFIG.tenantId}`,
    redirectUri: window.location.href.split('?')[0].split('#')[0],
  },
  cache: { cacheLocation: 'sessionStorage' },
};

const msalInstance = new msal.PublicClientApplication(msalConfig);
const SCOPES = ['Tasks.Read', 'Group.Read.All'];

// ============================================================
// STATE
// ============================================================
let LIVE_DATA = [];
let LIVE_RAW = {};
let accessToken = null;
let planId = null;
let lastSync = null;
let briefingLoaded = false, workloadLoaded = false, todayLoaded = false;
let conversationHistory = [];
let isLoading = false;

// ============================================================
// LOADING UI
// ============================================================
function setLoadingProgress(pct, status, detail) {
  document.getElementById('loadingBar').style.width = pct + '%';
  document.getElementById('loadingStatus').textContent = status;
  if (detail) document.getElementById('loadingDetail').textContent = detail;
}

function showError(msg, detail) {
  document.getElementById('loadingScreen').style.display = 'none';
  const es = document.getElementById('errorScreen');
  es.style.display = 'flex';
  document.getElementById('errorMsg').textContent = msg;
  document.getElementById('errorDetail').textContent = detail || '';
}

function hideLoadingScreen() {
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('errorScreen').style.display = 'none';
}

// ============================================================
// AUTH ‚Äî MSAL Interactive (popup)
// ============================================================
async function getAccessToken() {
  await msalInstance.initialize();

  // Handle the return from Microsoft login redirect
  const redirectResult = await msalInstance.handleRedirectPromise();
  if (redirectResult) {
    return redirectResult.accessToken;
  }

  const accounts = msalInstance.getAllAccounts();
  if (accounts.length > 0) {
    // Try silent acquisition first
    try {
      const result = await msalInstance.acquireTokenSilent({
        scopes: SCOPES,
        account: accounts[0],
      });
      return result.accessToken;
    } catch (e) {
      // Silent failed ‚Äî fall through to redirect
    }
  }

  // Redirect to Microsoft login page (avoids all popup issues)
  setLoadingProgress(15, 'Redirecting to Microsoft sign-in‚Ä¶', 'You will be redirected to sign in with your WCTV Microsoft 365 account.');
  await new Promise(r => setTimeout(r, 800));
  await msalInstance.loginRedirect({ scopes: SCOPES });
  return null; // page redirects away ‚Äî execution stops here
}

// ============================================================
// GRAPH API HELPERS
// ============================================================
async function graphGet(path) {
  const url = path.startsWith('http') ? path : GRAPH + path;
  const resp = await fetch(url, {
    headers: { Authorization: `Bearer ${accessToken}` }
  });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error(`Graph API ${path} failed (${resp.status}): ${txt.substring(0, 200)}`);
  }
  return resp.json();
}

async function graphGetAll(path) {
  let results = [];
  let nextLink = path;
  while (nextLink) {
    const data = await graphGet(nextLink);
    results = results.concat(data.value || []);
    nextLink = data['@odata.nextLink'] || null;
  }
  return results;
}

// ============================================================
// FIND THE "TO Tasks" PLAN
// ============================================================
async function findPlan() {
  // Try /me/planner/plans first (plans the signed-in user is a member of)
  try {
    const plans = await graphGetAll('/me/planner/plans');
    const match = plans.find(p => p.title === CONFIG.planName);
    if (match) return match.id;
  } catch(e) { /* fall through */ }

  // Fallback: search through joined groups
  const groups = await graphGetAll('/me/memberOf?$select=id,displayName&$top=100');
  for (const group of groups) {
    if (!group.id) continue;
    try {
      const plans = await graphGetAll(`/groups/${group.id}/planner/plans`);
      const match = plans.find(p => p.title === CONFIG.planName);
      if (match) return match.id;
    } catch(e) { /* group may not have Planner */ }
  }

  throw new Error(`Could not find a plan named "${CONFIG.planName}". Make sure you're signed in with an account that has access to this Planner plan.`);
}

// ============================================================
// FETCH PLANNER DATA
// ============================================================
async function fetchPlannerData(pid) {
  // Fetch tasks, buckets, and plan details (contains category/label names) in parallel
  const [tasks, buckets, planDetails] = await Promise.all([
    graphGetAll(`/planner/plans/${pid}/tasks`),
    graphGetAll(`/planner/plans/${pid}/buckets`),
    graphGet(`/planner/plans/${pid}/details`),
  ]);

  // Build bucket map: bucketId ‚Üí bucket name
  const bucketMap = {};
  buckets.forEach(b => { bucketMap[b.id] = b.name; });

  // Build category/label map: "category1" ‚Üí "GG", "category2" ‚Üí "CS", etc.
  // planDetails.categoryDescriptions contains the user-defined label names
  const categoryMap = {};
  if (planDetails.categoryDescriptions) {
    Object.entries(planDetails.categoryDescriptions).forEach(([key, val]) => {
      if (val) categoryMap[key] = val;
    });
  }

  // Fetch task details for notes in parallel batches
  const BATCH = 10;
  const detailsMap = {};
  for (let i = 0; i < tasks.length; i += BATCH) {
    const batch = tasks.slice(i, i + BATCH);
    await Promise.all(batch.map(async t => {
      try {
        const d = await graphGet(`/planner/tasks/${t.id}/details`);
        detailsMap[t.id] = d;
      } catch(e) { /* skip */ }
    }));
  }

  return { tasks, buckets, bucketMap, detailsMap, categoryMap };
}

// ============================================================
// NORMALIZE PLANNER TASKS ‚Üí Our data model
// ============================================================
function normalizeTasks(raw) {
  const { tasks, bucketMap, detailsMap, categoryMap } = raw;
  const today = new Date();

  return tasks.map(t => {
    const bucket = bucketMap[t.bucketId] || 'To do';
    const detail = detailsMap[t.id] || {};
    const notes = detail.description || '';
    const checklist = detail.checklist ? Object.values(detail.checklist) : [];

    // Due date
    let due = t.dueDateTime ? t.dueDateTime.substring(0, 10) : 'TBD';

    // Percent complete
    const pct = t.percentComplete || 0;

    // Status ‚Äî map Planner percentComplete to readable status
    // Also treat "To do" bucket tasks with 0% as Not Started
    let status = 'Not Started';
    if (pct === 100) status = 'Completed';
    else if (pct > 0) status = 'In Progress';
    else if (t.startDateTime) status = 'In Progress';

    // Priority mapping: Planner uses 0=urgent,1=important,3=medium,5=low,9=none
    const priMap = { 0: 'Urgent', 1: 'High', 3: 'Medium', 5: 'Low', 9: 'None' };
    const priority = priMap[t.priority] !== undefined ? priMap[t.priority] : 'Medium';

    // Labels ‚Äî map category keys (category1, category2...) to real display names
    // e.g. { category1: true, category3: true } ‚Üí ["GG", "CS"]
    const labels = t.appliedCategories
      ? Object.keys(t.appliedCategories)
          .filter(k => t.appliedCategories[k])
          .map(k => categoryMap[k] || k)  // use real name if available, fallback to key
      : [];

    // Assignees ‚Äî may be empty for unassigned tasks (that's fine, include them)
    const assignees = t.assignments ? Object.keys(t.assignments) : [];
    const isUnassigned = assignees.length === 0;

    // Check if overdue
    const isOverdue = due !== 'TBD' && new Date(due) < today && status !== 'Completed';

    return {
      id: t.id,
      task: t.title || '(Untitled)',
      bucket,
      priority,
      status,
      pct,
      due,
      isOverdue,
      isUnassigned,
      notes,
      labels,           // array of real label names e.g. ["GG", "Escalate"]
      assignees,
      checklist,
      hospital: extractHospital(t.title, notes),
      client: extractClient(t.title, notes, bucket),
      rawTask: t,
    };
  });
}

// Helper: try to extract hospital name from title
function extractHospital(title, notes) {
  const hospitals = ['MGMC','Laveen','MSW','Bakersfield','COH','Helford','Duarte','Simi Valley',
    'Glendale','UC Davis','Roseburg','LA General','Madera','Northridge','Orange County',
    'Brawerman','Sequoia','Fountain Valley','Washington'];
  const combined = (title + ' ' + notes).toLowerCase();
  for (const h of hospitals) {
    if (combined.includes(h.toLowerCase())) return h;
  }
  return '';
}

function extractClient(title, notes, bucket) {
  const clients = ['CommonSpirit','Adventist Health','City of Hope','UC Davis','LA General','SFDPH'];
  const combined = (title + ' ' + notes + ' ' + bucket).toLowerCase();
  for (const c of clients) {
    if (combined.includes(c.toLowerCase())) return c;
  }
  return '';
}

// ============================================================
// BUILD SUMMARY STRING FOR CLAUDE
// ============================================================
function buildDataSummary(tasks) {
  const today = new Date();
  const active = tasks.filter(t => t.status !== 'Completed');
  const completed = tasks.filter(t => t.status === 'Completed');
  const overdue = active.filter(t => t.isOverdue);
  const inProg = active.filter(t => t.status === 'In Progress');
  const notStarted = active.filter(t => t.status === 'Not Started');
  const unassigned = active.filter(t => t.isUnassigned);
  const soon = active.filter(t => {
    if (t.due === 'TBD') return false;
    const d = new Date(t.due);
    return !isNaN(d) && d >= today && (d - today) / 86400000 <= 14;
  });

  // Group by bucket
  const buckets = {};
  active.forEach(t => {
    const name = t.bucket || 'To do';
    if (!buckets[name]) buckets[name] = [];
    buckets[name].push(t);
  });

  // Group by label
  const labelGroups = {};
  active.forEach(t => {
    (t.labels || []).forEach(lbl => {
      if (!labelGroups[lbl]) labelGroups[lbl] = [];
      labelGroups[lbl].push(t);
    });
  });

  const taskLine = t =>
    `[${t.priority}][${t.status}][Bucket: ${t.bucket || 'To do'}]` +
    (t.labels?.length ? `[Labels: ${t.labels.join(', ')}]` : '') +
    (t.isUnassigned ? '[UNASSIGNED]' : '') +
    ` ${t.task} | Due: ${t.due} | ${t.pct}% | Notes: ${t.notes.substring(0, 100)}`;

  const lines = [
    `WCTV TO Tasks ‚Äî Live Planner Data ‚Äî ${new Date().toLocaleString()}`,
    `Total: ${tasks.length} | Active: ${active.length} | Completed: ${completed.length}`,
    `Overdue: ${overdue.length} | In Progress: ${inProg.length} | Not Started: ${notStarted.length} | Unassigned: ${unassigned.length}`,
    '',
    '=== LABELS / CATEGORIES IN USE ===',
    Object.entries(labelGroups).length
      ? Object.entries(labelGroups).map(([lbl, items]) =>
          `${lbl} (${items.length} tasks): ${items.map(i => i.task).slice(0, 5).join(' ¬∑ ')}`
        ).join('\n')
      : '(no labels applied)',
    '',
    '=== OVERDUE TASKS ===',
    ...overdue.slice(0, 15).map(taskLine),
    '',
    '=== DUE WITHIN 14 DAYS ===',
    ...soon.slice(0, 10).map(taskLine),
    '',
    '=== UNASSIGNED TASKS ===',
    unassigned.length ? unassigned.slice(0, 10).map(taskLine).join('\n') : '(none)',
    '',
    '=== BUCKETS & WORKLOAD ===',
    ...Object.entries(buckets).map(([b, items]) =>
      `${b}: ${items.length} active (${items.filter(i => ['High','Urgent'].includes(i.priority)).length} high/urgent)`),
    '',
    '=== ALL ACTIVE TASKS (up to 80) ===',
    ...active.slice(0, 80).map(taskLine),
  ];

  return lines.join('\n');
}

// ============================================================
// UPDATE UI STATS
// ============================================================
function updateStats(tasks) {
  const active = tasks.filter(t => t.status !== 'Completed');
  document.getElementById('statTotal').textContent = tasks.length;
  document.getElementById('statOverdue').textContent = active.filter(t => t.isOverdue).length;
  document.getElementById('statInProgress').textContent = active.filter(t => t.status === 'In Progress').length;
  document.getElementById('statNotStarted').textContent = active.filter(t => t.status === 'Not Started').length;
  document.getElementById('statCompleted').textContent = tasks.filter(t => t.status === 'Completed').length;
  lastSync = new Date();
  document.getElementById('statSync').textContent = lastSync.toLocaleTimeString();
  document.getElementById('dataTag').textContent = `TO Tasks ¬∑ ${tasks.length} tasks ¬∑ Live`;
  document.getElementById('liveDot').className = 'live-dot';
  document.getElementById('liveText').textContent = 'Live ¬∑ Planner';
  document.getElementById('refreshBtn').disabled = false;
}

// ============================================================
// INIT ‚Äî called on page load
// ============================================================
async function initPlanner() {
  document.getElementById('errorScreen').style.display = 'none';
  document.getElementById('loadingScreen').style.display = 'flex';
  document.getElementById('loadingBar').style.width = '0%';

  try {
    setLoadingProgress(5, 'Initializing‚Ä¶', 'Setting up Microsoft authentication.');
    accessToken = await getAccessToken();
    if (!accessToken) return; // redirecting to Microsoft login ‚Äî page will reload

    setLoadingProgress(35, 'Finding "TO Tasks" plan‚Ä¶', 'Scanning your Planner plans for TO Tasks.');
    planId = await findPlan();

    setLoadingProgress(55, 'Fetching tasks and buckets‚Ä¶', 'Downloading all tasks, buckets, and notes from Planner.');
    LIVE_RAW = await fetchPlannerData(planId);

    setLoadingProgress(82, 'Processing data‚Ä¶', 'Normalizing task data and building deployment intelligence.');
    LIVE_DATA = normalizeTasks(LIVE_RAW);

    setLoadingProgress(97, 'Almost ready‚Ä¶', '');
    updateStats(LIVE_DATA);

    await new Promise(r => setTimeout(r, 350));
    hideLoadingScreen();
    initUI();

  } catch(err) {
    console.error('Planner init error:', err);
    // User cancelled popup ‚Äî show friendlier message
    if (err.errorCode === 'user_cancelled' || err.message?.includes('user_cancelled')) {
      showError('Sign-in cancelled.', 'Click Retry to sign in with your Microsoft 365 account.');
    } else {
      showError('Could not connect to Microsoft Planner.', err.message);
    }
    document.getElementById('liveDot').className = 'live-dot error';
    document.getElementById('liveText').textContent = 'Offline';
  }
}

async function refreshData() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.classList.add('loading');
  document.getElementById('liveText').textContent = 'Syncing‚Ä¶';
  document.getElementById('liveDot').className = 'live-dot loading';

  try {
    accessToken = await getAccessToken();
    LIVE_RAW = await fetchPlannerData(planId);
    LIVE_DATA = normalizeTasks(LIVE_RAW);
    updateStats(LIVE_DATA);

    // Reset tabs so they re-render
    briefingLoaded = false;
    workloadLoaded = false;
    todayLoaded = false;

    addMessage('assistant', `<span class="section-head">üîÑ Data refreshed from Planner</span>

Pulled <strong>${LIVE_DATA.length} tasks</strong> live from TO Tasks. All tabs will regenerate with the latest data.

${buildQuickSummary(LIVE_DATA)}`);

    const banner = document.getElementById('plannerBanner');
    banner.className = 'planner-banner';
    banner.textContent = `‚úì Synced ${LIVE_DATA.length} tasks from TO Tasks ¬∑ ${new Date().toLocaleTimeString()}`;
    banner.classList.remove('hidden');
    setTimeout(() => banner.classList.add('hidden'), 5000);

  } catch(err) {
    addMessage('assistant', `<strong>‚ö† Refresh failed:</strong> ${err.message}`);
    document.getElementById('liveDot').className = 'live-dot error';
    document.getElementById('liveText').textContent = 'Error';
  }

  btn.classList.remove('loading');
  btn.disabled = false;
}

// ============================================================
// CLAUDE API KEY ‚Äî session only
// ============================================================
let CLAUDE_API_KEY = sessionStorage.getItem('wctv_claude_key') || null;

function showApiKeyModal() {
  document.getElementById('apikeyModal').classList.remove('hidden');
  setTimeout(() => document.getElementById('apikeyInput').focus(), 100);
}

function submitApiKey() {
  const val = document.getElementById('apikeyInput').value.trim();
  const errEl = document.getElementById('apikeyError');
  if (!val.startsWith('sk-ant-') || val.length < 20) {
    errEl.textContent = 'That doesn\'t look like a valid Claude API key. It should start with sk-ant-';
    errEl.classList.remove('hidden');
    return;
  }
  CLAUDE_API_KEY = val;
  sessionStorage.setItem('wctv_claude_key', val);
  document.getElementById('apikeyModal').classList.add('hidden');
  errEl.classList.add('hidden');
  // Show confirmation in header
  document.getElementById('liveText').textContent = 'Live ¬∑ Planner + AI';
}

function requireApiKey() {
  if (!CLAUDE_API_KEY) {
    showApiKeyModal();
    return false;
  }
  return true;
}

// ============================================================
// CHAT
// ============================================================
const chatEl = document.getElementById('tab-chat');

function addMessage(role, content) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  const avatar = role === 'assistant' ? '‚öô' : 'YOU';
  div.innerHTML = `
    <div class="msg-avatar">${avatar}</div>
    <div class="msg-bubble">${content}</div>
  `;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addTyping() {
  const div = document.createElement('div');
  div.className = 'msg assistant';
  div.id = 'typing';
  div.innerHTML = `
    <div class="msg-avatar">‚öô</div>
    <div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>
  `;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function removeTyping() {
  const t = document.getElementById('typing');
  if (t) t.remove();
}

function formatResponse(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/^### (.*)/gm, '<span class="section-head">$1</span>')
    .replace(/^## (.*)/gm, '<span class="section-head">$1</span>')
    .replace(/^# (.*)/gm, '<span class="section-head">$1</span>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n- /g, '<br>‚Ä¢ ')
    .replace(/\n(\d+)\. /g, '<br>$1. ')
    .replace(/\n/g, '<br>');
}

async function callClaude(userMessage) {
  if (!requireApiKey()) throw new Error('API key required');
  const summary = buildDataSummary(LIVE_DATA);
  const systemPrompt = `You are an intelligent deployment schedule analyzer for WCTV, a software deployment company serving hospitals. You have full access to live data pulled directly from the Microsoft Planner "TO Tasks" plan.

Your job is to help the team understand priorities, identify blockers, answer questions about specific projects, analyze workloads, and suggest what to work on next.

In Planner, BUCKETS represent team members or categories. TASK TITLES describe the work. NOTES contain updates and context. Tasks in the "To do" bucket (lowercase d) are unassigned or not yet assigned to a team member. Tasks marked [UNASSIGNED] have no assignee. Both should be included in all analysis.

Be concise but thorough. Use bold text for important items, names, and deadlines. When listing items, be specific ‚Äî include the task title, who it's assigned to (bucket), and due date.

LIVE PLANNER DATA (as of ${lastSync ? lastSync.toLocaleString() : 'just now'}):
${summary}

Today's date is ${new Date().toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'})}. Q1 2026 ends March 31, 2026.

When answering about priorities, focus on: 1) overdue items, 2) items due within 14 days, 3) High/Urgent priority items with 0% progress, 4) items with open questions in notes blocking progress.`;

  conversationHistory.push({ role: "user", content: userMessage });

  const response = await fetch("https://morning-union-1dc9.ahaag.workers.dev/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-api-key": CLAUDE_API_KEY,
      "anthropic-version": "2023-06-01",
    },
    body: JSON.stringify({
      model: "claude-sonnet-4-20250514",
      max_tokens: 1000,
      system: systemPrompt,
      messages: conversationHistory
    })
  });

  const data = await response.json();
  const reply = data.content?.[0]?.text || "Sorry, I couldn't process that request.";
  conversationHistory.push({ role: "assistant", content: reply });
  return reply;
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg || isLoading) return;

  input.value = '';
  isLoading = true;
  document.getElementById('sendBtn').disabled = true;

  addMessage('user', msg);
  addTyping();

  try {
    const reply = await callClaude(msg);
    removeTyping();
    addMessage('assistant', formatResponse(reply));
  } catch (e) {
    removeTyping();
    if (e.message === 'API key required') {
      // modal already shown by requireApiKey()
      isLoading = false;
      document.getElementById('sendBtn').disabled = false;
      return;
    }
    addMessage('assistant', '<strong>Error:</strong> Could not reach the Claude API. Check your connection.');
  }

  isLoading = false;
  document.getElementById('sendBtn').disabled = false;
  input.focus();
}

function quickAsk(q) {
  switchTab('chat');
  document.getElementById('chatInput').value = q;
  sendMessage();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

// ============================================================
// TABS
// ============================================================
function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', ['chat','briefing','workload','today'][i] === name);
  });
  ['chat','briefing','workload','today'].forEach(n => {
    const el = document.getElementById(`tab-${n}`);
    if (el) el.classList.toggle('hidden', n !== name);
  });
  document.getElementById('inputBar').classList.toggle('hidden', name !== 'chat');

  if (name === 'briefing' && !briefingLoaded) { renderBriefing(); briefingLoaded = true; }
  if (name === 'workload' && !workloadLoaded) { renderWorkload(); workloadLoaded = true; }
  if (name === 'today' && !todayLoaded) { renderToday(); todayLoaded = true; }
}

// ============================================================
// BUILD QUICK SUMMARY (for welcome + refresh messages)
// ============================================================
function buildQuickSummary(tasks) {
  const today = new Date();
  const active = tasks.filter(t => t.status !== 'Completed');
  const overdue = active.filter(t => t.isOverdue);
  const inProg = active.filter(t => t.status === 'In Progress');
  const soon = active.filter(t => {
    if (t.due === 'TBD') return false;
    const d = new Date(t.due);
    return !isNaN(d) && d >= today && (d - today) / 86400000 <= 14;
  });
  const highNotStarted = active.filter(t => ['High','Urgent'].includes(t.priority) && t.status === 'Not Started');

  return `‚Ä¢ <strong>${overdue.length}</strong> overdue tasks\n‚Ä¢ <strong>${inProg.length}</strong> currently In Progress\n‚Ä¢ <strong>${soon.length}</strong> due within 14 days\n‚Ä¢ <strong>${highNotStarted.length}</strong> High/Urgent priority not yet started`;
}

// ============================================================
// BRIEFING TAB
// ============================================================
function renderBriefing() {
  const el = document.getElementById('tab-briefing');
  const today = new Date();
  const active = LIVE_DATA.filter(t => t.status !== 'Completed');
  const overdue = active.filter(t => t.isOverdue);
  const inProg = active.filter(t => t.status === 'In Progress');
  const soon = active.filter(t => {
    if (t.due === 'TBD') return false;
    const d = new Date(t.due);
    return !isNaN(d) && d >= today && (d - today) / 86400000 <= 14;
  });
  const near = active.filter(t => {
    if (t.due === 'TBD') return false;
    const d = new Date(t.due);
    return t.pct >= 80 && !isNaN(d) && t.status !== 'Completed';
  });
  const highNotStarted = active.filter(t => ['High','Urgent'].includes(t.priority) && t.status === 'Not Started');

  const makeCard = (task, cls='') => `
    <div class="brief-card ${cls}">
      <div class="brief-card-title">${escHtml(task.task)}${task.due !== 'TBD' ? ` ‚Äî Due ${task.due}` : ''}</div>
      <div class="brief-card-sub">
        ${task.bucket ? `<strong>Bucket:</strong> ${escHtml(task.bucket)} ¬∑ ` : ''}
        ${task.pct}% complete${task.notes ? ` ¬∑ ${escHtml(task.notes.substring(0,120))}` : ''}
      </div>
    </div>`;

  el.innerHTML = `
    <div class="briefing-header">Weekly Deployment Briefing</div>
    <div class="briefing-date">${new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})} ¬∑ Live from TO Tasks</div>

    <div class="brief-grid">
      <div class="brief-stat-box"><div class="brief-stat-num" style="color:#c8441a">${overdue.length}</div><div class="brief-stat-lbl">Overdue</div></div>
      <div class="brief-stat-box"><div class="brief-stat-num" style="color:#7ab0d8">${inProg.length}</div><div class="brief-stat-lbl">In Progress</div></div>
      <div class="brief-stat-box"><div class="brief-stat-num" style="color:#e0a060">${soon.length}</div><div class="brief-stat-lbl">Due in 14 Days</div></div>
    </div>

    <div class="brief-section">
      <div class="brief-section-title">üî¥ Overdue ‚Äî Needs Immediate Attention</div>
      ${overdue.length === 0 ? '<div class="brief-card ok-card"><div class="brief-card-title">No overdue tasks üéâ</div></div>' : overdue.slice(0,8).map(t => makeCard(t)).join('')}
    </div>

    <div class="brief-section">
      <div class="brief-section-title">üìÖ Due Within 14 Days</div>
      ${soon.length === 0 ? '<div class="brief-card info-card"><div class="brief-card-title">No tasks due in the next 14 days.</div></div>' : soon.slice(0,8).map(t => makeCard(t,'warn-card')).join('')}
    </div>

    <div class="brief-section">
      <div class="brief-section-title">‚ö° High/Urgent ‚Äî Not Yet Started</div>
      ${highNotStarted.length === 0 ? '<div class="brief-card ok-card"><div class="brief-card-title">All high priority items have been started.</div></div>' : highNotStarted.slice(0,6).map(t => makeCard(t)).join('')}
    </div>

    <div class="brief-section">
      <div class="brief-section-title">‚úÖ Near Completion (80%+) ‚Äî Push to Close</div>
      ${near.length === 0 ? '<div class="brief-card info-card"><div class="brief-card-title">No tasks at 80%+ right now.</div></div>' : near.slice(0,6).map(t => makeCard(t,'ok-card')).join('')}
    </div>
  `;
}

// ============================================================
// WORKLOAD TAB
// ============================================================
function renderWorkload() {
  const el = document.getElementById('tab-workload');
  const active = LIVE_DATA.filter(t => t.status !== 'Completed');

  // Group by bucket (team member)
  const buckets = {};
  active.forEach(t => {
    const name = t.bucket || '(Unassigned)';
    if (!buckets[name]) buckets[name] = [];
    buckets[name].push(t);
  });

  const sorted = Object.entries(buckets).sort((a,b) => b[1].length - a[1].length);

  el.innerHTML = `<h2 style="font-family:'Sora',sans-serif;font-size:1.5rem;font-weight:800;margin-bottom:4px;color:var(--navy)">Team Workload</h2>
<p style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:24px;">Active tasks per bucket ¬∑ Live from Planner</p>`;

  sorted.forEach(([name, items], i) => {
    const count = items.length;
    const highCount = items.filter(d => ['High','Urgent'].includes(d.priority)).length;
    const maxLoad = 12;
    const pct = Math.min((count / maxLoad) * 100, 100);
    const loadColor = count >= 8 ? '#c8441a' : count >= 5 ? '#e0a060' : '#2e7d5b';
    const loadLabel = count >= 8 ? 'overloaded' : count >= 5 ? 'busy' : 'manageable';
    const loadClass = count >= 8 ? 'overloaded' : count >= 5 ? 'busy' : 'ok-load';

    const chips = items.slice(0, 8).map(item => {
      const cls = ['High','Urgent'].includes(item.priority) ? 'task-high' : 'task-med';
      const label = `${item.task.substring(0,35)}${item.task.length > 35 ? '‚Ä¶' : ''}`;
      return `<span class="person-task-chip ${cls}">${escHtml(label)}</span>`;
    }).join('');
    const more = count > 8 ? `<span class="person-task-chip" style="color:var(--muted)">+${count-8} more</span>` : '';

    el.innerHTML += `<div class="person-card" style="animation-delay:${i*0.06}s">
      <div class="person-header">
        <div>
          <div class="person-name">${escHtml(name)}</div>
          <div style="font-size:0.62rem;color:var(--muted)"><strong style="color:var(--red)">${highCount} high/urgent</strong> of ${count} active tasks</div>
        </div>
        <span class="person-count ${loadClass}">${count} tasks ¬∑ ${loadLabel}</span>
      </div>
      <div class="load-bar"><div class="load-fill" style="width:${pct}%;background:${loadColor}"></div></div>
      <div class="person-tasks">${chips}${more}</div>
    </div>`;
  });
}

// ============================================================
// TODAY TAB ‚Äî AI-generated via Claude
// ============================================================
async function renderToday() {
  const el = document.getElementById('tab-today');

  if (!requireApiKey()) {
    el.innerHTML = `<div class="today-title">Tackle Today</div>
<div class="today-sub" style="color:var(--red);">Claude API key required ‚Äî enter your key to generate AI recommendations.</div>`;
    todayLoaded = false; // allow retry after key is entered
    return;
  }

  el.innerHTML = `<div class="today-title">Tackle Today</div>
<div class="today-sub">Generating AI recommendations from live Planner data‚Ä¶</div>
<div class="today-item" style="justify-content:center;">
  <div class="typing-indicator" style="justify-content:center;"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
</div>`;

  try {
    const summary = buildDataSummary(LIVE_DATA);
    const todayStr = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});

    const resp = await fetch("https://morning-union-1dc9.ahaag.workers.dev/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": CLAUDE_API_KEY,
        "anthropic-version": "2023-06-01",
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1200,
        messages: [{
          role: "user",
          content: `Based on the live Planner deployment data below, generate the top 6-8 specific action items the WCTV team should tackle TODAY (${todayStr}).

For each item, provide:
1. A specific action (not just "work on X" ‚Äî what exactly should be done?)
2. The reason this is the highest priority right now
3. The bucket/team member responsible
4. Due date if relevant

Format your response as JSON array:
[
  {
    "task": "specific action to take today",
    "why": "reason this is critical right now",
    "tags": ["bucket/person", "due date or urgency"],
    "urgent": true or false
  }
]

Only respond with valid JSON, no other text.

PLANNER DATA:
${summary}`
        }]
      })
    });

    const data = await resp.json();
    const raw = data.content?.[0]?.text || '[]';
    const clean = raw.replace(/```json|```/g,'').trim();
    const items = JSON.parse(clean);

    el.innerHTML = `<div class="today-title">Tackle Today</div>
<div class="today-sub">Top recommended actions ¬∑ ${todayStr} ¬∑ AI-generated from live Planner data</div>`;

    items.forEach((item, i) => {
      const tagHtml = (item.tags||[]).map(t => `<span class="today-tag${item.urgent?' urgent-tag':''}">${escHtml(t)}</span>`).join('');
      el.innerHTML += `<div class="today-item" style="animation-delay:${i*0.07}s">
        <div class="today-num">${String(i+1).padStart(2,'0')}</div>
        <div class="today-content">
          <div class="today-task-name">${escHtml(item.task)}</div>
          <div class="today-why">${escHtml(item.why)}</div>
          <div class="today-meta">${tagHtml}</div>
        </div>
      </div>`;
    });

  } catch(err) {
    el.innerHTML = `<div class="today-title">Tackle Today</div>
<div style="font-size:0.78rem;color:var(--red);padding:20px;">Could not generate recommendations: ${escHtml(err.message)}</div>`;
  }
}

// ============================================================
// UTILS
// ============================================================
function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================================================
// INIT UI (after data loaded)
// ============================================================
function initUI() {
  const today = new Date();
  const active = LIVE_DATA.filter(t => t.status !== 'Completed');
  const overdue = active.filter(t => t.isOverdue);
  const soon = active.filter(t => {
    if (t.due === 'TBD') return false;
    const d = new Date(t.due);
    return !isNaN(d) && d >= today && (d - today) / 86400000 <= 14;
  });
  const highNotStarted = active.filter(t => ['High','Urgent'].includes(t.priority) && t.status === 'Not Started');

  addMessage('assistant', `<span class="section-head">üìã Live data loaded from TO Tasks</span>

I've pulled <strong>${LIVE_DATA.length} tasks</strong> directly from your Microsoft Planner plan and I'm ready to analyze priorities, surface blockers, and answer questions.

Here's what stands out right now:

‚Ä¢ <strong>${overdue.length} tasks are overdue</strong>${overdue.length > 0 ? ` ‚Äî the most urgent: <em>${escHtml(overdue[0]?.task)}</em>` : ' ‚Äî great work!'}
‚Ä¢ <strong>${soon.length} tasks</strong> are due within the next 14 days
‚Ä¢ <strong>${highNotStarted.length} High/Urgent items</strong> haven't been started yet

Use the tabs above for a full weekly briefing, team workload breakdown, and today's AI-generated action list. Ask me anything about your deployment schedule!`);

  // Prompt for API key if not already in session
  if (!CLAUDE_API_KEY) {
    setTimeout(() => showApiKeyModal(), 600);
  }
}

// ============================================================
// KICK OFF
// ============================================================
initPlanner();
</script>
</body>
</html>
