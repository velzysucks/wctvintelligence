<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WCTV AI Deployment Analyzer</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #f5f2ec;
  --surface: #ffffff;
  --border: #e0dbd0;
  --ink: #1a1714;
  --muted: #8a8278;
  --accent: #c8441a;
  --accent2: #2a5f8f;
  --accent3: #2e7d5b;
  --tag-bg: #ede9e1;
  --shadow: 0 2px 16px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.12);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'IBM Plex Mono', monospace;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* HEADER */
header {
  background: var(--ink);
  color: var(--bg);
  padding: 14px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  border-bottom: 3px solid var(--accent);
}
.logo-wrap { display: flex; align-items: baseline; gap: 14px; }
.logo {
  font-family: 'Instrument Serif', serif;
  font-size: 1.4rem;
  letter-spacing: -0.01em;
  color: #f5f2ec;
}
.logo em { color: var(--accent); font-style: italic; }
.header-sub { font-size: 0.62rem; color: #8a8278; text-transform: uppercase; letter-spacing: 0.1em; }
.header-right { display: flex; align-items: center; gap: 16px; }
.live-badge {
  display: flex; align-items: center; gap: 6px;
  font-size: 0.65rem; color: #7ec89a; text-transform: uppercase; letter-spacing: 0.08em;
}
.live-dot { width: 6px; height: 6px; border-radius: 50%; background: #7ec89a; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
.data-tag { font-size: 0.6rem; color: #8a8278; }

/* LAYOUT */
.app-body { display: flex; flex: 1; overflow: hidden; }

/* SIDEBAR */
.sidebar {
  width: 260px;
  background: var(--ink);
  color: #c8c0b4;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  border-right: 1px solid #2a2620;
  overflow-y: auto;
}
.sidebar-section { padding: 16px 18px; border-bottom: 1px solid #2a2620; }
.sidebar-label { font-size: 0.58rem; text-transform: uppercase; letter-spacing: 0.12em; color: #5a5248; margin-bottom: 10px; }
.quick-btn {
  display: block; width: 100%;
  background: transparent;
  border: 1px solid #2a2620;
  color: #a09890;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.68rem;
  text-align: left;
  padding: 9px 12px;
  cursor: pointer;
  border-radius: 3px;
  margin-bottom: 6px;
  transition: all 0.15s;
  line-height: 1.4;
}
.quick-btn:hover { background: #2a2620; color: #f5f2ec; border-color: #3a3630; }
.quick-btn .qb-icon { margin-right: 6px; }

.stat-mini { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.stat-mini-label { font-size: 0.64rem; color: #6a6258; }
.stat-mini-val { font-size: 0.8rem; font-weight: 600; }
.val-red { color: #e07060; }
.val-amber { color: #e0a060; }
.val-green { color: #7ec89a; }
.val-blue { color: #7ab0d8; }

/* MAIN CHAT AREA */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); }

/* TABS */
.tabs {
  display: flex;
  background: var(--surface);
  border-bottom: 2px solid var(--border);
  flex-shrink: 0;
}
.tab {
  padding: 12px 22px;
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  cursor: pointer;
  color: var(--muted);
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.15s;
  background: none; border-top: none; border-left: none; border-right: none;
  font-family: 'IBM Plex Mono', monospace;
}
.tab:hover { color: var(--ink); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

/* MESSAGES */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px 32px;
  display: flex;
  flex-direction: column;
  gap: 18px;
}
.msg { display: flex; gap: 12px; animation: msgIn 0.25s ease; max-width: 860px; }
@keyframes msgIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
.msg.user { align-self: flex-end; flex-direction: row-reverse; }
.msg-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.75rem; flex-shrink: 0; margin-top: 2px;
}
.msg.assistant .msg-avatar { background: var(--ink); color: #f5f2ec; }
.msg.user .msg-avatar { background: var(--accent); color: #fff; font-weight: 600; }
.msg-bubble {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px 10px 10px 10px;
  padding: 14px 18px;
  font-size: 0.8rem;
  line-height: 1.7;
  box-shadow: var(--shadow);
  max-width: 720px;
}
.msg.user .msg-bubble {
  background: var(--ink);
  color: #f5f2ec;
  border-color: var(--ink);
  border-radius: 10px 2px 10px 10px;
}
.msg-bubble strong { color: var(--accent); font-weight: 600; }
.msg-bubble .section-head {
  font-family: 'Instrument Serif', serif;
  font-size: 1rem;
  color: var(--ink);
  display: block;
  margin-bottom: 8px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 6px;
}
.msg-bubble ul { margin: 8px 0 8px 16px; }
.msg-bubble li { margin-bottom: 5px; }
.msg-bubble .item-chip {
  display: inline-block;
  background: var(--tag-bg);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 1px 7px;
  font-size: 0.7rem;
  margin: 2px 2px;
  color: var(--ink);
}
.msg-bubble .urgent-chip {
  background: rgba(200,68,26,0.08);
  border-color: rgba(200,68,26,0.3);
  color: var(--accent);
}
.msg-bubble .ok-chip {
  background: rgba(46,125,91,0.08);
  border-color: rgba(46,125,91,0.3);
  color: var(--accent3);
}
.msg-bubble .warn-chip {
  background: rgba(42,95,143,0.08);
  border-color: rgba(42,95,143,0.3);
  color: var(--accent2);
}
.typing-indicator { display: flex; gap: 4px; padding: 4px 0; align-items: center; }
.typing-dot { width: 6px; height: 6px; background: var(--muted); border-radius: 50%; animation: bounce 1.2s infinite; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-5px)} }

/* BRIEFING PANEL */
.briefing-panel { flex: 1; overflow-y: auto; padding: 24px 32px; }
.briefing-header {
  font-family: 'Instrument Serif', serif;
  font-size: 2rem;
  margin-bottom: 4px;
  color: var(--ink);
}
.briefing-date { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 28px; }
.brief-section { margin-bottom: 28px; }
.brief-section-title {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  padding-bottom: 8px;
  margin-bottom: 14px;
}
.brief-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  padding: 14px 18px;
  margin-bottom: 10px;
  border-radius: 0 4px 4px 0;
  box-shadow: var(--shadow);
}
.brief-card.ok-card { border-left-color: var(--accent3); }
.brief-card.warn-card { border-left-color: #e0a060; }
.brief-card.info-card { border-left-color: var(--accent2); }
.brief-card-title { font-size: 0.78rem; font-weight: 600; margin-bottom: 4px; color: var(--ink); }
.brief-card-sub { font-size: 0.7rem; color: var(--muted); line-height: 1.5; }
.brief-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
.brief-stat-box {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 16px 18px;
  text-align: center;
  box-shadow: var(--shadow);
}
.brief-stat-num { font-family: 'Instrument Serif', serif; font-size: 2.2rem; line-height: 1; margin-bottom: 4px; }
.brief-stat-lbl { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; }

/* WORKLOAD PANEL */
.workload-panel { flex: 1; overflow-y: auto; padding: 24px 32px; }
.person-card {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 18px 22px;
  margin-bottom: 14px;
  box-shadow: var(--shadow);
  border-radius: 4px;
  animation: msgIn 0.3s ease both;
}
.person-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.person-name { font-family: 'Instrument Serif', serif; font-size: 1.15rem; }
.person-count {
  font-size: 0.65rem;
  padding: 4px 10px;
  border-radius: 3px;
  font-weight: 600;
}
.overloaded { background: rgba(200,68,26,0.1); color: var(--accent); border: 1px solid rgba(200,68,26,0.3); }
.busy { background: rgba(224,160,96,0.1); color: #c07030; border: 1px solid rgba(224,160,96,0.3); }
.ok-load { background: rgba(46,125,91,0.1); color: var(--accent3); border: 1px solid rgba(46,125,91,0.3); }
.person-tasks { display: flex; flex-wrap: wrap; gap: 6px; }
.person-task-chip {
  font-size: 0.65rem;
  background: var(--tag-bg);
  border: 1px solid var(--border);
  padding: 3px 9px;
  border-radius: 3px;
  color: var(--ink);
}
.person-task-chip.task-high { border-left: 3px solid var(--accent); }
.person-task-chip.task-med { border-left: 3px solid #e0a060; }
.load-bar { height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 10px; overflow: hidden; }
.load-fill { height: 100%; border-radius: 2px; transition: width 0.8s ease; }

/* TODAY PANEL */
.today-panel { flex: 1; overflow-y: auto; padding: 24px 32px; }
.today-title {
  font-family: 'Instrument Serif', serif;
  font-size: 1.8rem;
  margin-bottom: 4px;
}
.today-sub { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 24px; }
.today-item {
  display: flex;
  gap: 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 16px 20px;
  margin-bottom: 10px;
  box-shadow: var(--shadow);
  border-radius: 4px;
  animation: msgIn 0.3s ease both;
  align-items: flex-start;
}
.today-num {
  font-family: 'Instrument Serif', serif;
  font-size: 1.8rem;
  line-height: 1;
  color: var(--border);
  min-width: 32px;
}
.today-content { flex: 1; }
.today-task-name { font-size: 0.82rem; font-weight: 600; margin-bottom: 4px; color: var(--ink); }
.today-why { font-size: 0.72rem; color: var(--muted); line-height: 1.5; margin-bottom: 8px; }
.today-meta { display: flex; gap: 8px; flex-wrap: wrap; }
.today-tag { font-size: 0.62rem; padding: 2px 8px; border-radius: 3px; border: 1px solid var(--border); background: var(--tag-bg); }
.today-tag.urgent-tag { background: rgba(200,68,26,0.08); border-color: rgba(200,68,26,0.3); color: var(--accent); }

/* INPUT BAR */
.input-bar {
  background: var(--surface);
  border-top: 2px solid var(--border);
  padding: 14px 24px;
  display: flex;
  gap: 10px;
  flex-shrink: 0;
}
.input-bar textarea {
  flex: 1;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--ink);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.8rem;
  padding: 10px 14px;
  border-radius: 4px;
  resize: none;
  outline: none;
  transition: border-color 0.2s;
  max-height: 100px;
  line-height: 1.5;
}
.input-bar textarea:focus { border-color: var(--accent2); }
.send-btn {
  background: var(--ink);
  color: #f5f2ec;
  border: none;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.72rem;
  font-weight: 600;
  padding: 0 20px;
  cursor: pointer;
  border-radius: 4px;
  letter-spacing: 0.05em;
  transition: background 0.15s;
  text-transform: uppercase;
}
.send-btn:hover { background: var(--accent); }
.send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* Scrollbar */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.hidden { display: none !important; }

/* UPLOAD BUTTON in header */
.upload-btn {
  display: flex; align-items: center; gap: 6px;
  background: transparent;
  border: 1px solid #3a3630;
  color: #a09890;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.65rem;
  padding: 6px 12px;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.15s;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.upload-btn:hover { border-color: var(--accent); color: var(--accent); }
.upload-btn .up-icon { font-size: 0.85rem; }

/* MODAL OVERLAY */
.modal-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(10,8,6,0.82);
  display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
  animation: fadeIn 0.2s ease;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.modal-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-top: 3px solid var(--accent);
  padding: 32px 36px;
  width: 480px;
  box-shadow: var(--shadow-lg);
  border-radius: 4px;
  animation: slideUp 0.25s ease;
}
@keyframes slideUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
.modal-title {
  font-family: 'Instrument Serif', serif;
  font-size: 1.4rem;
  margin-bottom: 4px;
  color: var(--ink);
}
.modal-sub { font-size: 0.68rem; color: var(--muted); margin-bottom: 24px; }

/* DROP ZONE */
.drop-zone {
  border: 2px dashed var(--border);
  border-radius: 6px;
  padding: 36px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--bg);
  position: relative;
}
.drop-zone:hover, .drop-zone.drag-over {
  border-color: var(--accent);
  background: rgba(200,68,26,0.04);
}
.drop-zone input[type=file] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
}
.dz-icon { font-size: 2.2rem; margin-bottom: 10px; }
.dz-label { font-size: 0.8rem; font-weight: 600; color: var(--ink); margin-bottom: 4px; }
.dz-sub { font-size: 0.68rem; color: var(--muted); }

/* PARSE PROGRESS */
.parse-status {
  margin-top: 16px;
  font-size: 0.72rem;
  color: var(--muted);
  text-align: center;
  min-height: 20px;
}
.parse-status.success { color: var(--accent3); font-weight: 600; }
.parse-status.error { color: var(--accent); }

.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.modal-cancel {
  background: transparent; border: 1px solid var(--border);
  color: var(--muted); font-family: 'IBM Plex Mono', monospace;
  font-size: 0.7rem; padding: 8px 18px; border-radius: 3px; cursor: pointer;
}
.modal-cancel:hover { border-color: var(--ink); color: var(--ink); }
.modal-confirm {
  background: var(--ink); border: none; color: #f5f2ec;
  font-family: 'IBM Plex Mono', monospace; font-weight: 600;
  font-size: 0.7rem; padding: 8px 18px; border-radius: 3px; cursor: pointer;
  opacity: 0.4; pointer-events: none; transition: all 0.15s;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.modal-confirm.ready { opacity: 1; pointer-events: all; }
.modal-confirm.ready:hover { background: var(--accent3); }

/* Sidebar upload section */
.sidebar-upload-btn {
  display: block; width: 100%;
  background: rgba(200,68,26,0.1);
  border: 1px dashed rgba(200,68,26,0.4);
  color: #e07060;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 0.68rem;
  text-align: center;
  padding: 10px 12px;
  cursor: pointer;
  border-radius: 3px;
  transition: all 0.15s;
}
.sidebar-upload-btn:hover { background: rgba(200,68,26,0.18); border-color: var(--accent); color: var(--accent); }
</style>
</head>
<body>

<header>
  <div class="logo-wrap">
    <div class="logo">WCTV <em>Intelligence</em></div>
    <div class="header-sub">Deployment AI Analyzer</div>
  </div>
  <div class="header-right">
    <div class="live-badge"><div class="live-dot"></div> Claude Powered</div>
    <div class="data-tag" id="dataTag">Sheet: 2-17-2026 ¬∑ 176 items</div>
    <button class="upload-btn" onclick="openUploadModal()"><span class="up-icon">‚¨Ü</span> Load New Sheet</button>
  </div>
</header>

<!-- UPLOAD MODAL -->
<div class="modal-overlay hidden" id="uploadModal">
  <div class="modal-box">
    <div class="modal-title">Load New Spreadsheet</div>
    <div class="modal-sub">Upload your updated .xlsx deployment schedule ‚Äî all tabs will refresh automatically with the new data.</div>
    <div class="drop-zone" id="dropZone">
      <input type="file" accept=".xlsx,.xls,.csv" id="fileInput" onchange="handleFileSelect(this.files[0])">
      <div class="dz-icon">üìÇ</div>
      <div class="dz-label">Drop your .xlsx file here</div>
      <div class="dz-sub">or click to browse ¬∑ supports .xlsx, .xls, .csv</div>
    </div>
    <div class="parse-status" id="parseStatus"></div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeUploadModal()">Cancel</button>
      <button class="modal-confirm" id="confirmBtn" onclick="applyNewData()">Apply & Refresh ‚Üª</button>
    </div>
  </div>
</div>

<div class="app-body">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Quick Asks</div>
      <button class="quick-btn" onclick="quickAsk('What are the most critical items my team needs to tackle this week?')"><span class="qb-icon">üî¥</span> This week's critical items</button>
      <button class="quick-btn" onclick="quickAsk('Which items are overdue and what should we do about them?')"><span class="qb-icon">‚ö†Ô∏è</span> Overdue items</button>
      <button class="quick-btn" onclick="quickAsk('Summarize all the MobileCare issues across all clients')"><span class="qb-icon">üì±</span> MobileCare issues</button>
      <button class="quick-btn" onclick="quickAsk('What is blocking progress on the City of Hope Orange County project?')"><span class="qb-icon">üöß</span> COH OC blockers</button>
      <button class="quick-btn" onclick="quickAsk('What are the open questions that need answers before we can move forward?')"><span class="qb-icon">‚ùì</span> Open questions</button>
      <button class="quick-btn" onclick="quickAsk('Summarize the status of all CommonSpirit deployments')"><span class="qb-icon">üè•</span> CommonSpirit status</button>
      <button class="quick-btn" onclick="quickAsk('What items are due in Q1 2026 that are not yet started?')"><span class="qb-icon">üìÖ</span> Q1 not started</button>
      <button class="quick-btn" onclick="quickAsk('Which team members appear to have the most active high-priority tasks?')"><span class="qb-icon">üë•</span> Team workload</button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Data</div>
      <button class="sidebar-upload-btn" onclick="openUploadModal()">‚¨Ü Load Updated Spreadsheet</button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Live Stats</div>
      <div class="stat-mini"><span class="stat-mini-label">Critical/ASAP</span><span class="stat-mini-val val-red">8</span></div>
      <div class="stat-mini"><span class="stat-mini-label">Overdue</span><span class="stat-mini-val val-amber">14</span></div>
      <div class="stat-mini"><span class="stat-mini-label">In Progress</span><span class="stat-mini-val val-blue">38</span></div>
      <div class="stat-mini"><span class="stat-mini-label">Not Started / High</span><span class="stat-mini-val val-red">6</span></div>
      <div class="stat-mini"><span class="stat-mini-label">On Hold</span><span class="stat-mini-val val-amber">42</span></div>
      <div class="stat-mini"><span class="stat-mini-label">Issues</span><span class="stat-mini-val val-red">9</span></div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('chat')">üí¨ Chat</button>
      <button class="tab" onclick="switchTab('briefing')">üìã Weekly Briefing</button>
      <button class="tab" onclick="switchTab('workload')">üë• Team Workload</button>
      <button class="tab" onclick="switchTab('today')">‚ö° Tackle Today</button>
    </div>

    <!-- CHAT TAB -->
    <div id="tab-chat" class="messages" style="flex:1;overflow-y:auto;"></div>

    <!-- BRIEFING TAB -->
    <div id="tab-briefing" class="briefing-panel hidden"></div>

    <!-- WORKLOAD TAB -->
    <div id="tab-workload" class="workload-panel hidden"></div>

    <!-- TODAY TAB -->
    <div id="tab-today" class="today-panel hidden"></div>

    <!-- INPUT BAR (only on chat) -->
    <div class="input-bar" id="inputBar">
      <textarea id="chatInput" rows="2" placeholder="Ask anything about your deployment schedule... e.g. 'What should Aranda focus on today?'" onkeydown="handleKey(event)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send ‚Üë</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const DEPLOYMENT_DATA = [
  {job:"23-64",idn:"CommonSpirit",hospital:"MGMC",task:"MGMC MobileCare Issues (Routine Cancel)",priority:"High",status:"In Progress",pct:75,due:"ASAP",field:"Cummins",techops:"Aranda / Larson",update:"1/28: Still pending update from factory on fix. Job still on hold due to payment, however we still need to pressure the factory on a fix as this affects multiple customers.",openQ:"",ticket:"17521",type:"Issue"},
  {job:"21-09",idn:"City of Hope",hospital:"Helford / Duarte",task:"Consoles freezing / stuck calls and tasks",priority:"High",status:"In Progress",pct:50,due:"2026-01-30",field:"Sevilla",techops:"Aranda/Galvan",update:"1/28: Update Liaison - fixes this issue. Need to schedule.",openQ:"",ticket:"17401",type:"Issue"},
  {job:"N/A",idn:"Multiple",hospital:"MGMC / Laveen / COH Duarte / COH OC",task:"Stuck calls/tasks in MobileCare (multi-site)",priority:"High",status:"In Progress",pct:50,due:"2026-01-30",field:"",techops:"Aranda / McFarlane",update:"Root cause determined. Liaison changes required. CS Laveen - Need to schedule.",openQ:"",ticket:"15873",type:"Issue"},
  {job:"21-09",idn:"City of Hope",hospital:"Helford / Duarte",task:"Analytics system patch",priority:"High",status:"In Progress",pct:25,due:"2026-02-27",field:"Sevilla",techops:"Aranda",update:"12/19: Need Commit Dates. Radford testing solution with Bradford.",openQ:"",ticket:"16062",type:"Issue"},
  {job:"21-111",idn:"City of Hope",hospital:"Orange County",task:"COH OC MobileCare",priority:"High",status:"In Progress",pct:95,due:"2025-12-01",field:"Sevilla",techops:"Aranda/Haag",update:"12/26: Schedule updates to match Helford.",openQ:"DA: Open new line item for updates?",ticket:"",type:"Software"},
  {job:"21-111",idn:"City of Hope",hospital:"Orange County",task:"COH OC Test Servers",priority:"High",status:"In Progress",pct:75,due:"2026-01-09",field:"Sevilla",techops:"Aranda/Galvan",update:"1/2: Meeting scheduled for 1/14. Open Items: Install MobileCare, Configure EEE/Liaison/SIP Proxy.",openQ:"Confirm test server order",ticket:"",type:"Activity"},
  {job:"21-111",idn:"City of Hope",hospital:"Orange County",task:"COH OC FocusCare Code Blue Redirection",priority:"High",status:"In Progress",pct:25,due:"2026-01-30",field:"Sevilla",techops:"Aranda",update:"1/2: Blocked by other open items for COH.",openQ:"",ticket:"",type:"Activity"},
  {job:"22-06",idn:"CommonSpirit",hospital:"Bakersfield Mercy Southwest",task:"MSW Analytics",priority:"High",status:"Not Started",pct:0,due:"2026-02-27",field:"Maldonado",techops:"Haag",update:"",openQ:"Who owns sending the DM backup to factory?",ticket:"",type:""},
  {job:"22-06",idn:"CommonSpirit",hospital:"Bakersfield Mercy Southwest",task:"MSW EMR Inbound",priority:"High",status:"In Progress",pct:0,due:"2026-02-02",field:"Maldonado",techops:"Haag",update:"Laveen testing completed. Next: Coordinate with CS and WCNC for discovery and testing.",openQ:"",ticket:"",type:""},
  {job:"22-06",idn:"CommonSpirit",hospital:"Bakersfield Mercy Southwest",task:"MSW MobileCare",priority:"High",status:"Hold",pct:0,due:"2026-01-30",field:"Maldonado",techops:"Aranda/Haag",update:"1/27: On hold until the rest of the hospital is ready for MobileCare.",openQ:"Multiple MobileCare go lives at same time",ticket:"",type:"Software"},
  {job:"22-06",idn:"CommonSpirit",hospital:"Bakersfield Mercy Southwest",task:"MSW WFS",priority:"Medium",status:"In Progress",pct:50,due:"2026-02-27",field:"Maldonado",techops:"Aranda",update:"2 WFS still showing offline. EMR integration not scheduled yet.",openQ:"Offline WFS, additional training needed?",ticket:"",type:"Software"},
  {job:"23-67",idn:"Adventist Health",hospital:"Simi Valley",task:"AH Simi Valley MobileCare",priority:"High",status:"In Progress",pct:25,due:"Need Update",field:"Schouw",techops:"Haag",update:"Units with Novus will not have Callback. Work with factory on next steps. DO WE HAVE TEST PHONES?",openQ:"",ticket:"",type:""},
  {job:"23-67",idn:"Adventist Health",hospital:"Simi Valley",task:"AH Simi Overhead Paging",priority:"High",status:"In Progress",pct:80,due:"2025-12-30",field:"Maldonado/Sevilla",techops:"Haag/Larson",update:"1/23: Call Concentrator implemented, connection issues resolved.",openQ:"",ticket:"",type:""},
  {job:"23-67",idn:"Adventist Health",hospital:"Simi Valley",task:"AH Simi Valley ADT",priority:"High",status:"In Progress",pct:95,due:"2026-01-09",field:"Maldonado",techops:"Aranda/McFarlane",update:"12/31: Room name changes updated. Completing validation through 1/9.",openQ:"",ticket:"",type:"Software"},
  {job:"23-69",idn:"CommonSpirit",hospital:"Bakersfield Memorial",task:"Bakersfield Memorial Server Migration",priority:"High",status:"In Progress",pct:25,due:"Q1 2026",field:"Sevilla/Maldonado",techops:"Haag",update:"Migration complete to Virtual server. Need to schedule onsite time. Needs Cerner Team coordination.",openQ:"Isolated network. Physical server live. Need to coordinate with Cerner.",ticket:"",type:""},
  {job:"24-88",idn:"UC Davis",hospital:"UC Davis",task:"UCDavis Schneider Electric Integration",priority:"High",status:"In Progress",pct:90,due:"2025-12-31",field:"Mehl",techops:"Haag / Radford",update:"Need to update MR on LPS issues.",openQ:"",ticket:"",type:""},
  {job:"25-22",idn:"CommonSpirit",hospital:"Laveen",task:"Laveen MobileCare (Cancel Routine Calls)",priority:"High",status:"In Progress",pct:25,due:"Q1 2026",field:"Cummins",techops:"Aranda",update:"Ball in court with Factory.",openQ:"",ticket:"",type:""},
  {job:"25-22",idn:"CommonSpirit",hospital:"Laveen",task:"Laveen MobileCare (Stuck Tasks)",priority:"High",status:"In Progress",pct:90,due:"Q1 2026",field:"Cummins",techops:"Aranda",update:"1/28: Liaison update 151 fixes issue. Need to schedule to deploy.",openQ:"",ticket:"",type:""},
  {job:"25-22",idn:"CommonSpirit",hospital:"Laveen",task:"Laveen MobileCare (Timeout 13hr)",priority:"High",status:"In Progress",pct:90,due:"Q1 2026",field:"Cummins",techops:"Aranda",update:"1/28: Factory wants to shadow - scheduled for next week Thursday, need to align resources.",openQ:"",ticket:"",type:""},
  {job:"25-22",idn:"CommonSpirit",hospital:"Laveen",task:"Laveen MobileCare random logouts",priority:"High",status:"Not Started",pct:0,due:"Q1 2026",field:"Cummins",techops:"Aranda",update:"",openQ:"",ticket:"",type:""},
  {job:"25-22",idn:"CommonSpirit",hospital:"Laveen",task:"Laveen WFS",priority:"Medium",status:"In Progress",pct:50,due:"Q1 2026",field:"Cummins",techops:"Aranda",update:"ORU/ORM needs validation with the factory.",openQ:"",ticket:"",type:"Software"},
  {job:"25-22",idn:"CommonSpirit",hospital:"Laveen",task:"Laveen Analytics",priority:"Medium",status:"In Progress",pct:50,due:"Q1 2026",field:"Cummins",techops:"Aranda/Haag",update:"1/28: Status unclear. Danielle emailed Rhett for update.",openQ:"",ticket:"",type:"Software"},
  {job:"N/A",idn:"CommonSpirit",hospital:"MGMC",task:"MGMC Logout Issues",priority:"High",status:"In Progress",pct:10,due:"2025-12-31",field:"Cummins",techops:"Aranda",update:"1/28: Meeting regarding WiFi network certification. Check timeout interval.",openQ:"Next steps?",ticket:"17486",type:"Issue"},
  {job:"N/A",idn:"CommonSpirit",hospital:"MGMC",task:"MGMC Volume Issue",priority:"High",status:"On Hold",pct:95,due:"2025-12-31",field:"Cummins",techops:"Aranda",update:"Site needs to update phones to Android 13. Spectralink quote provided. Ball in court with CS.",openQ:"DA: Close?",ticket:"17474",type:"Issue"},
  {job:"25-78",idn:"CommonSpirit",hospital:"Ringold",task:"CS Ringgold LiNK RTLS / WCNCS Integration",priority:"High",status:"In Progress",pct:25,due:"2025-01-11",field:"Jaech",techops:"Haag",update:"Will work with LiNK team > WCNCS Team.",openQ:"",ticket:"",type:""},
  {job:"25-82",idn:"City of Hope",hospital:"Brawerman",task:"COH Brawerman Add-on (Analytics validation)",priority:"Medium",status:"In Progress",pct:90,due:"2025-12-31",field:"Muller/Sevilla",techops:"Aranda/Haag",update:"1/28: Need to validate new rooms in Analytics. Restrooms added.",openQ:"",ticket:"",type:"Fix"},
  {job:"25-83",idn:"N/A",hospital:"Madera",task:"Madera TQI Install",priority:"Medium",status:"In Progress",pct:90,due:"2026-02-28",field:"Bentley",techops:"Larson",update:"Need to finalize issues with service running properly.",openQ:"",ticket:"",type:""},
  {job:"Need Update",idn:"CommonSpirit",hospital:"Bakersfield Memorial",task:"Bakersfield Memorial: Cerner/Oracle Cloud Migration",priority:"High",status:"In Progress",pct:25,due:"Need Update",field:"Sevilla",techops:"Haag",update:"CS not communicating internally. Started project without knowing we are moving servers EOY.",openQ:"",ticket:"",type:""},
  {job:"24-34",idn:"CommonSpirit",hospital:"Northridge",task:"CS Northridge Analytics",priority:"Medium",status:"In Progress",pct:5,due:"2026-03-01",field:"Muller",techops:"Haag",update:"1/5: request sent to Rhett. Submit order to factory pending programming.",openQ:"",ticket:"",type:""},
  {job:"N/A",idn:"Adventist Health",hospital:"Enterprise",task:"AH Enterprise Analytics",priority:"High",status:"In Progress",pct:25,due:"Need Update",field:"Sevilla/Maldonado",techops:"Haag",update:"All actions are only for Simi on the enterprise server.",openQ:"",ticket:"",type:""},
  {job:"25-102",idn:"CommonSpirit",hospital:"CHI Roseburg",task:"CHI Roseburg - Analytics, LDAP, ADT/HL7",priority:"Medium",status:"Not Started",pct:0,due:"2026-03-01",field:"Mehl",techops:"TBD",update:"Q1 2026 target.",openQ:"",ticket:"",type:""},
  {job:"25-101",idn:"LA General",hospital:"LA General",task:"2A/3rd/7th Floor ADT, Historian/TQI",priority:"Medium",status:"Not Started",pct:0,due:"Q1 2026",field:"Sevilla",techops:"TBD",update:"1/28: FC Room List needed. Need Ryan to coordinate with ADT team.",openQ:"",ticket:"",type:""},
  {job:"24-40",idn:"Adventist Health",hospital:"Glendale",task:"AH Glendale ADT",priority:"Medium",status:"In Progress",pct:0,due:"Q1 2026",field:"Muller",techops:"Aranda",update:"Programming not completed. Waiting on Cerner vs Epic integration decision.",openQ:"",ticket:"",type:"Software"},
  {job:"21-111",idn:"City of Hope",hospital:"Orange County",task:"OCLFCC & OCH Code Blue PBX Integration",priority:"High",status:"Hold",pct:90,due:"2026-03-01",field:"Sevilla",techops:"Haag",update:"Work complete, ready for CAB + training. HOLD FOR PAYMENT FROM HENSEL PHELPS.",openQ:"",ticket:"",type:""},
  {job:"N/A",idn:"N/A",hospital:"Multi-site",task:"Manual MobileCare Task Clearing (Ongoing)",priority:"Medium",status:"In Progress",pct:0,due:"Ongoing",field:"",techops:"McFarlane / Aranda",update:"Server access requested for Mariah for COH, CS, and AH. Instructions in Confluence.",openQ:"",ticket:"",type:""}
];

const DATA_SUMMARY = `
WCTV SOFTWARE DEPLOYMENT SCHEDULE ‚Äî As of February 19, 2026
Sheet: 2-17-2026 | Total items: 176 active items

KEY TEAM MEMBERS:
- Aranda (TechOps) ‚Äî most involved person, across nearly all active items
- Haag (TechOps) ‚Äî heavy involvement in analytics, server work
- McFarlane (TechOps) ‚Äî MobileCare task clearing, ADT procedures
- Larson (TechOps) ‚Äî Laguna Honda, Schneider, various
- Galvan (TechOps) ‚Äî COH items
- Maldonado (Field) ‚Äî CommonSpirit MSW, Adventist Health sites
- Sevilla (Field) ‚Äî City of Hope, CS Bakersfield Memorial, AH Simi
- Cummins (Field) ‚Äî CommonSpirit MGMC, Laveen
- Muller (Field) ‚Äî Northridge, Glendale, AH Bakersfield
- Mehl (Field) ‚Äî UC Davis, Laguna Honda, CHI Roseburg
- Bentley (Field) ‚Äî Madera, AH Sonora, Seneca

TOP CRITICAL/OVERDUE ITEMS:
1. MGMC MobileCare Issues (Routine Cancel) ‚Äî ASAP, Issue, 75% done, ticket 17521. Factory fix pending. Affects multiple customers.
2. Consoles freezing/stuck calls (COH Helford/Duarte) ‚Äî Due 1/30 (OVERDUE), Issue. Liaison update fix available, need to schedule.
3. Stuck calls in MobileCare multi-site (MGMC/Laveen/COH) ‚Äî Due 1/30 (OVERDUE). Root cause known, Liaison changes required.
4. COH OC MobileCare ‚Äî Due 12/1/25 (OVERDUE), 95% complete. Updates needed.
5. COH OC Test Servers ‚Äî Due 1/9/26 (OVERDUE), 75% complete.
6. COH OC FocusCare Code Blue Redirection ‚Äî Due 1/30 (OVERDUE), 25% done. Blocked by other COH items.
7. MSW MobileCare ‚Äî Due 1/30 (OVERDUE), On Hold until hospital ready.
8. MGMC Logout Issues ‚Äî Due 12/31/25 (OVERDUE), 10% done. WiFi cert meeting held 1/28.

UPCOMING DUE DATES (next 30 days):
- MSW EMR Inbound ‚Äî Due 2/2 (HIGH, 0% done)
- MSW Analytics ‚Äî Due 2/27 (HIGH, 0% started)
- COH Helford Analytics patch ‚Äî Due 2/27 (HIGH, 25%)
- MSW WFS ‚Äî Due 2/27 (Medium, 50%)
- COH OC Hospital Analytics ‚Äî Due 2/27 (Medium, 0%)
- CS Northridge Analytics ‚Äî Due 3/1 (Medium, 5%)
- CHI Roseburg ‚Äî Due 3/1 (Medium, Not Started)
- Madera TQI Install ‚Äî Due 2/28 (Medium, 90%)
- COH Brawerman Add-on ‚Äî Due 12/31/25 (OVERDUE, 90%)

OPEN QUESTIONS NEEDING ANSWERS:
- MSW Analytics: Who owns sending DM backup to factory?
- COH OC MobileCare: Open new line item for updates?
- COH OC Test Servers: Confirm test server order and lab setup
- MSW WFS: Offline WFS and training questions
- MSW MobileCare: Multiple MobileCare go-lives at same time
- MGMC Logout Issues: What are next steps after WiFi meeting?
- AH Glendale ADT: Move forward with Cerner or wait for Epic integration?
- COH Brawerman: New rooms not showing in Analytics

BLOCKED/ON HOLD ITEMS (key):
- MSW MobileCare: On hold until hospital ready
- COH OC Code Blue PBX: Complete, on hold pending Hensel Phelps payment
- MGMC Volume Issue: Ball in CS court (Android 13 phones needed)
- Laveen MobileCare Timeout: Factory wants to shadow, need to align resources

CLIENTS:
- CommonSpirit: MGMC, Laveen, MSW (Bakersfield), Bakersfield Memorial, Northridge, Ringgold, CHI Roseburg
- City of Hope: Helford/Duarte, Orange County, Brawerman
- Adventist Health: Simi Valley, Bakersfield, Glendale, White Memorial, Reedley, Portland, Tillamook, Delano
- UC Davis: Main campus, Schneider Electric Integration
- LA General, Madera, SFDPH Laguna Honda, Seneca, Washington Hospital
`;

// ============================================================
// CHAT
// ============================================================
const chatEl = document.getElementById('tab-chat');
let isLoading = false;
let conversationHistory = [];

function addMessage(role, content) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  const avatar = role === 'assistant' ? '‚öô' : 'YOU';
  div.innerHTML = `
    <div class="msg-avatar">${avatar}</div>
    <div class="msg-bubble">${content}</div>
  `;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addTyping() {
  const div = document.createElement('div');
  div.className = 'msg assistant';
  div.id = 'typing';
  div.innerHTML = `
    <div class="msg-avatar">‚öô</div>
    <div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>
  `;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function removeTyping() {
  const t = document.getElementById('typing');
  if (t) t.remove();
}

function formatResponse(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/^### (.*)/gm, '<span class="section-head">$1</span>')
    .replace(/^## (.*)/gm, '<span class="section-head">$1</span>')
    .replace(/^# (.*)/gm, '<span class="section-head">$1</span>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n- /g, '<br>‚Ä¢ ')
    .replace(/\n(\d+)\. /g, '<br>$1. ')
    .replace(/\n/g, '<br>');
}

async function callClaude(userMessage) {
  const systemPrompt = `You are an intelligent deployment schedule analyzer for WCTV, a software deployment company serving hospitals. You have full access to the current deployment schedule data below.

Your job is to help the team understand priorities, identify blockers, answer questions about specific projects, analyze workloads, and suggest what to work on next.

Be concise but thorough. Use bold text for important items, names, and deadlines. When listing items, be specific ‚Äî include the hospital name, job number if relevant, and who is assigned.

DEPLOYMENT DATA:
${DATA_SUMMARY}

Today's date is February 19, 2026. Q1 2026 ends March 31, 2026.

When answering about priorities, focus on: 1) overdue items, 2) ASAP items, 3) due dates within 14 days, 4) High priority items with 0% progress, 5) open questions blocking progress.`;

  conversationHistory.push({ role: "user", content: userMessage });

  const response = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      model: "claude-sonnet-4-20250514",
      max_tokens: 1000,
      system: systemPrompt,
      messages: conversationHistory
    })
  });

  const data = await response.json();
  const reply = data.content?.[0]?.text || "Sorry, I couldn't process that request.";
  conversationHistory.push({ role: "assistant", content: reply });
  return reply;
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg || isLoading) return;

  input.value = '';
  isLoading = true;
  document.getElementById('sendBtn').disabled = true;

  addMessage('user', msg);
  addTyping();

  try {
    const reply = await callClaude(msg);
    removeTyping();
    addMessage('assistant', formatResponse(reply));
  } catch (e) {
    removeTyping();
    addMessage('assistant', '<strong>Error:</strong> Could not reach the Claude API. Please check your connection and try again.');
  }

  isLoading = false;
  document.getElementById('sendBtn').disabled = false;
  input.focus();
}

function quickAsk(q) {
  switchTab('chat');
  document.getElementById('chatInput').value = q;
  sendMessage();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

// ============================================================
// TABS
// ============================================================
let briefingLoaded = false, workloadLoaded = false, todayLoaded = false;

function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.toggle('active', ['chat','briefing','workload','today'][i] === name);
  });
  ['chat','briefing','workload','today'].forEach(n => {
    const el = document.getElementById(`tab-${n}`);
    if (el) el.classList.toggle('hidden', n !== name);
  });
  document.getElementById('inputBar').classList.toggle('hidden', name !== 'chat');

  if (name === 'briefing' && !briefingLoaded) { renderBriefing(); briefingLoaded = true; }
  if (name === 'workload' && !workloadLoaded) { renderWorkload(); workloadLoaded = true; }
  if (name === 'today' && !todayLoaded) { renderToday(); todayLoaded = true; }
}

// ============================================================
// BRIEFING
// ============================================================
function renderBriefing() {
  const el = document.getElementById('tab-briefing');
  el.innerHTML = `
    <div class="briefing-header">Weekly Deployment Briefing</div>
    <div class="briefing-date">Week of February 19, 2026 ¬∑ Auto-generated from sheet 2-17-2026</div>

    <div class="brief-grid">
      <div class="brief-stat-box"><div class="brief-stat-num" style="color:#c8441a">8</div><div class="brief-stat-lbl">Critical / ASAP</div></div>
      <div class="brief-stat-box"><div class="brief-stat-num" style="color:#e0a060">14</div><div class="brief-stat-lbl">Overdue Items</div></div>
      <div class="brief-stat-box"><div class="brief-stat-num" style="color:#2e7d5b">38</div><div class="brief-stat-lbl">In Progress</div></div>
    </div>

    <div class="brief-section">
      <div class="brief-section-title">üî¥ Immediate Action Required (This Week)</div>
      <div class="brief-card"><div class="brief-card-title">MSW EMR Inbound ‚Äî Due Feb 2 (17 days overdue)</div><div class="brief-card-sub">Job 22-06 ¬∑ CommonSpirit / Bakersfield Mercy Southwest ¬∑ Assigned: Maldonado (Field), Haag (TechOps) ¬∑ 0% complete ¬∑ Next: Coordinate with CS and WCNC for discovery and testing.</div></div>
      <div class="brief-card"><div class="brief-card-title">MGMC MobileCare Routine Cancel ‚Äî ASAP</div><div class="brief-card-sub">Job 23-64 ¬∑ CommonSpirit / MGMC ¬∑ Ticket 17521 ¬∑ Assigned: Cummins/Aranda/Larson ¬∑ 75% done ¬∑ Factory fix pending. Affects multiple customers. Need to pressure factory.</div></div>
      <div class="brief-card"><div class="brief-card-title">MGMC Logout Issues ‚Äî Overdue since Dec 31</div><div class="brief-card-sub">Ticket 17486 ¬∑ Assigned: Cummins/Aranda ¬∑ 10% done ¬∑ WiFi cert meeting on 1/28. Next steps unclear ‚Äî needs decision.</div></div>
      <div class="brief-card"><div class="brief-card-title">COH Helford ‚Äî Stuck Calls & Frozen Consoles</div><div class="brief-card-sub">Ticket 17401 ¬∑ Assigned: Sevilla/Aranda/Galvan ¬∑ Liaison update fix is available ‚Äî need to schedule deployment ASAP.</div></div>
    </div>

    <div class="brief-section">
      <div class="brief-section-title">üìÖ Due Within 14 Days</div>
      <div class="brief-card warn-card"><div class="brief-card-title">MSW Analytics ‚Äî Due Feb 27</div><div class="brief-card-sub">Job 22-06 ¬∑ 0% done ¬∑ Not started ¬∑ Open question: Who owns sending DM backup to factory?</div></div>
      <div class="brief-card warn-card"><div class="brief-card-title">COH Analytics Patch ‚Äî Due Feb 27</div><div class="brief-card-sub">Job 21-09 ¬∑ 25% done ¬∑ Need commit dates from factory for testing environment.</div></div>
      <div class="brief-card warn-card"><div class="brief-card-title">MSW WFS ‚Äî Due Feb 27</div><div class="brief-card-sub">Job 22-06 ¬∑ 50% done ¬∑ 2 WFS offline, EMR integration not yet scheduled.</div></div>
      <div class="brief-card warn-card"><div class="brief-card-title">Madera TQI Install ‚Äî Due Feb 28</div><div class="brief-card-sub">Job 25-83 ¬∑ 90% done ¬∑ Need to finalize service running issues. Close to done.</div></div>
    </div>

    <div class="brief-section">
      <div class="brief-section-title">üöß Blocked ‚Äî Waiting on External Action</div>
      <div class="brief-card info-card"><div class="brief-card-title">COH OC Code Blue PBX Integration ‚Äî Hold (Payment)</div><div class="brief-card-sub">90% complete. Work done. Waiting for payment from Hensel Phelps before CAB + training can proceed.</div></div>
      <div class="brief-card info-card"><div class="brief-card-title">MSW MobileCare ‚Äî On Hold</div><div class="brief-card-sub">Waiting until rest of Bakersfield Mercy Southwest is ready for MobileCare go-live.</div></div>
      <div class="brief-card info-card"><div class="brief-card-title">Laveen MobileCare Timeout ‚Äî Factory Shadow Pending</div><div class="brief-card-sub">90% done. Factory wants to shadow session ‚Äî scheduled next Thursday. Need to align resources.</div></div>
      <div class="brief-card info-card"><div class="brief-card-title">UC Davis Servers ‚Äî Waiting on PO</div><div class="brief-card-sub">Servers/Software for Midtown, Cadillac, Towers. Waiting on PO from UCD.</div></div>
    </div>

    <div class="brief-section">
      <div class="brief-section-title">‚úÖ Near Completion (80%+) ‚Äî Push to Close</div>
      <div class="brief-card ok-card"><div class="brief-card-title">COH OC MobileCare ‚Äî 95%</div><div class="brief-card-sub">Sevilla/Aranda/Haag ¬∑ Overdue since Dec 1. Updates needed to match Helford.</div></div>
      <div class="brief-card ok-card"><div class="brief-card-title">AH Simi Valley ADT ‚Äî 95%</div><div class="brief-card-sub">Maldonado/Aranda/McFarlane ¬∑ Completing validation through 1/9. Finalize and close out.</div></div>
      <div class="brief-card ok-card"><div class="brief-card-title">UCDavis Schneider Electric Integration ‚Äî 90%</div><div class="brief-card-sub">Mehl/Haag/Radford ¬∑ Need to update MR on LPS issues. Very close to done.</div></div>
      <div class="brief-card ok-card"><div class="brief-card-title">Laveen MobileCare (Stuck Tasks) ‚Äî 90%</div><div class="brief-card-sub">Cummins/Aranda ¬∑ Liaison update 151 fix confirmed. Schedule deployment.</div></div>
    </div>
  `;
}

// ============================================================
// WORKLOAD
// ============================================================
function renderWorkload() {
  const el = document.getElementById('tab-workload');

  const people = {
    "Aranda": { items: [], role: "TechOps" },
    "Haag": { items: [], role: "TechOps" },
    "Cummins": { items: [], role: "Field" },
    "Maldonado": { items: [], role: "Field" },
    "Sevilla": { items: [], role: "Field" },
    "Muller": { items: [], role: "Field" },
    "McFarlane": { items: [], role: "TechOps" },
    "Mehl": { items: [], role: "Field" },
    "Larson": { items: [], role: "TechOps" },
    "Bentley": { items: [], role: "Field" },
  };

  const active = DEPLOYMENT_DATA.filter(d => {
    const s = d.status.toLowerCase();
    return !['closed','cancelled','completed'].includes(s);
  });

  active.forEach(item => {
    const combined = `${item.field} ${item.techops}`;
    Object.keys(people).forEach(name => {
      if (combined.toLowerCase().includes(name.toLowerCase())) {
        people[name].items.push(item);
      }
    });
  });

  const sorted = Object.entries(people).sort((a,b) => b[1].items.length - a[1].items.length);

  el.innerHTML = `<h2 style="font-family:'Instrument Serif',serif;font-size:1.6rem;margin-bottom:4px;">Team Workload</h2>
<p style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:24px;">Active items per team member ¬∑ Feb 19, 2026</p>`;

  sorted.forEach(([name, data], i) => {
    const count = data.items.length;
    const highCount = data.items.filter(d => d.priority.toLowerCase() === 'high').length;
    const maxLoad = 12;
    const pct = Math.min((count / maxLoad) * 100, 100);
    const loadColor = count >= 8 ? '#c8441a' : count >= 5 ? '#e0a060' : '#2e7d5b';
    const loadLabel = count >= 8 ? 'overloaded' : count >= 5 ? 'busy' : 'manageable';
    const loadClass = count >= 8 ? 'overloaded' : count >= 5 ? 'busy' : 'ok-load';

    const chips = data.items.slice(0, 8).map(item => {
      const cls = item.priority.toLowerCase() === 'high' ? 'task-high' : 'task-med';
      const label = `${item.hospital !== 'N/A' ? item.hospital : item.idn} ‚Äî ${item.task.substring(0,30)}${item.task.length > 30 ? '‚Ä¶' : ''}`;
      return `<span class="person-task-chip ${cls}">${label}</span>`;
    }).join('');
    const more = count > 8 ? `<span class="person-task-chip" style="color:var(--muted)">+${count-8} more</span>` : '';

    el.innerHTML += `<div class="person-card" style="animation-delay:${i*0.06}s">
      <div class="person-header">
        <div>
          <div class="person-name">${name}</div>
          <div style="font-size:0.62rem;color:var(--muted)">${data.role} ¬∑ <strong style="color:var(--accent)">${highCount} high priority</strong></div>
        </div>
        <span class="person-count ${loadClass}">${count} active ¬∑ ${loadLabel}</span>
      </div>
      <div class="load-bar"><div class="load-fill" style="width:${pct}%;background:${loadColor}"></div></div>
      <div class="person-tasks">${chips}${more}</div>
    </div>`;
  });
}

// ============================================================
// TODAY
// ============================================================
function renderToday() {
  const el = document.getElementById('tab-today');
  el.innerHTML = `<div class="today-title">Tackle Today</div>
<div class="today-sub">Top recommended actions for February 19, 2026</div>`;

  const todayItems = [
    { task: "Schedule Liaison update deployment for COH Helford (Stuck Calls fix)", why: "Liaison update 151 fixes the stuck calls/frozen consoles issue. The fix is confirmed ‚Äî this just needs a scheduling call. Multiple COH sites affected. Do this today.", tags: ["COH Helford/Duarte", "Sevilla / Aranda", "Issue #17401"], urgent: true },
    { task: "Pressure factory on MGMC Routine Cancel fix (Ticket 17521)", why: "Marked ASAP, affects multiple customers. Factory has had this long enough. A direct follow-up call or escalation is needed today.", tags: ["CommonSpirit MGMC", "Cummins / Aranda", "Ticket 17521"], urgent: true },
    { task: "Confirm alignment of resources for Laveen Timeout factory shadow (Thursday)", why: "Factory shadow session is scheduled for Thursday Feb 19-ish. With 90% completion, aligning your team member to be present is a critical gate to closing this item.", tags: ["CommonSpirit Laveen", "Cummins / Aranda", "Q1 2026"], urgent: true },
    { task: "Answer open question: Who sends MSW Analytics DM backup to factory?", why: "MSW Analytics is 0% done and due Feb 27. The entire task is blocked by this single unanswered ownership question. Resolve today ‚Äî 8 days remain.", tags: ["CS Bakersfield MSW", "Maldonado / Haag", "Due Feb 27"], urgent: true },
    { task: "Get commit dates for COH Analytics patch testing environment", why: "COH Analytics patch is 25% done with a Feb 27 deadline. The last recorded update (12/19) says 'Need Commit Dates' ‚Äî this needs a follow-up call to Radford/Bradford.", tags: ["City of Hope Helford", "Sevilla / Aranda", "Due Feb 27"], urgent: false },
    { task: "Finalize and close Madera TQI Install (90% done)", why: "90% complete with a Feb 28 deadline. One known blocker: service not running properly. One focused session should close this out.", tags: ["Madera", "Bentley / Larson", "Due Feb 28"], urgent: false },
    { task: "COH Brawerman Analytics ‚Äî validate new rooms are showing up", why: "90% done. The final open item is confirming restrooms added in the renovation appear correctly in Analytics. Quick validation task.", tags: ["City of Hope Brawerman", "Muller / Sevilla / Haag", "Fix"], urgent: false },
    { task: "Kick off CHI Roseburg (Analytics, LDAP, ADT/HL7)", why: "Not started, Due March 1. 10 days away. Even a scoping call or resource assignment today prevents a scramble next week.", tags: ["CommonSpirit CHI Roseburg", "Mehl / TBD", "Due Mar 1"], urgent: false },
  ];

  todayItems.forEach((item, i) => {
    const tagHtml = item.tags.map(t => `<span class="today-tag${item.urgent ? ' urgent-tag' : ''}">${t}</span>`).join('');
    el.innerHTML += `<div class="today-item" style="animation-delay:${i*0.07}s">
      <div class="today-num">${String(i+1).padStart(2,'0')}</div>
      <div class="today-content">
        <div class="today-task-name">${item.task}</div>
        <div class="today-why">${item.why}</div>
        <div class="today-meta">${tagHtml}</div>
      </div>
    </div>`;
  });
}

// ============================================================
// INIT
// ============================================================
addMessage('assistant', `<span class="section-head">Good morning ‚Äî here's your deployment intelligence.</span>

I've analyzed your <strong>176-item WCTV deployment schedule</strong> (sheet: 2-17-2026) and I'm ready to answer questions, surface priorities, and help you plan.

A few things jump out right now:

‚Ä¢ <strong>8 items are ASAP or overdue</strong> ‚Äî the most urgent is the <strong>MGMC MobileCare routine cancel bug</strong> (Ticket 17521, factory fix still pending)
‚Ä¢ <strong>MSW EMR Inbound</strong> is 0% done and due Feb 2 ‚Äî already 17 days late
‚Ä¢ <strong>Laveen Timeout fix</strong> has a factory shadow session this week ‚Äî make sure you're aligned on resources
‚Ä¢ <strong>4 items</strong> are due in the next 10 days and not yet started

Try asking me anything ‚Äî check the tabs above for a full weekly briefing, team workload breakdown, and today's recommended action list.
<br><br><strong>üí° Tip:</strong> Use the <em>‚¨Ü Load New Sheet</em> button in the top-right corner (or the sidebar) to update the analyzer with your latest spreadsheet at any time.`);

// ============================================================
// UPLOAD & PARSE
// ============================================================
let pendingData = null;
let pendingFileName = '';

function openUploadModal() {
  document.getElementById('uploadModal').classList.remove('hidden');
  document.getElementById('parseStatus').textContent = '';
  document.getElementById('parseStatus').className = 'parse-status';
  document.getElementById('confirmBtn').classList.remove('ready');
  document.getElementById('fileInput').value = '';
  pendingData = null;
}

function closeUploadModal() {
  document.getElementById('uploadModal').classList.add('hidden');
}

// Drag and drop
const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) handleFileSelect(file);
});

function handleFileSelect(file) {
  if (!file) return;
  pendingFileName = file.name;
  const status = document.getElementById('parseStatus');
  status.textContent = '‚è≥ Parsing spreadsheet...';
  status.className = 'parse-status';

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array', cellDates: true });

      // Use the first (most recent) sheet
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

      // Find header row (look for "Job", "Task", "Priority" etc.)
      let headerRow = -1;
      let headers = [];
      for (let i = 0; i < Math.min(rows.length, 10); i++) {
        const r = rows[i].map(c => String(c).trim().toLowerCase());
        if (r.includes('job') || r.includes('task') || r.includes('priority')) {
          headerRow = i;
          headers = rows[i].map(c => String(c).trim().toLowerCase());
          break;
        }
      }

      if (headerRow === -1) {
        status.textContent = '‚ùå Could not find header row. Make sure your sheet has columns like Job, Task, Priority, Status, Due Date.';
        status.className = 'parse-status error';
        return;
      }

      // Map column indices
      const col = (names) => {
        for (const n of names) {
          const idx = headers.findIndex(h => h.includes(n));
          if (idx >= 0) return idx;
        }
        return -1;
      };

      const colJob = col(['job']);
      const colIDN = col(['idn']);
      const colHosp = col(['hospital']);
      const colTask = col(['task']);
      const colPri = col(['priority']);
      const colStatus = col(['status']);
      const colPct = col(['percent', 'pct', '%', 'complete']);
      const colDue = col(['due date', 'due']);
      const colField = col(['field assigned', 'field update', 'field']);
      const colTechops = col(['techops assigned', 'techops']);
      const colUpdate = col(['techops update', 'update']);
      const colOpenQ = col(['open question', 'open q']);
      const colTicket = col(['factory ticket', 'ticket']);
      const colType = col(['type']);

      const parsed = [];
      for (let i = headerRow + 1; i < rows.length; i++) {
        const r = rows[i];
        const task = colTask >= 0 ? String(r[colTask] || '').trim() : '';
        if (!task) continue;

        // Format due date
        let due = colDue >= 0 ? r[colDue] : '';
        if (due instanceof Date) {
          due = due.toISOString().split('T')[0];
        } else {
          due = String(due || '').trim();
        }

        // Parse percent
        let pct = colPct >= 0 ? r[colPct] : 0;
        if (typeof pct === 'string') pct = parseFloat(pct.replace('%','')) || 0;
        if (pct > 1 && pct <= 100) pct = Math.round(pct);
        else if (pct <= 1 && pct > 0) pct = Math.round(pct * 100);

        parsed.push({
          job: String(colJob >= 0 ? r[colJob] : '').trim(),
          idn: String(colIDN >= 0 ? r[colIDN] : '').trim(),
          hospital: String(colHosp >= 0 ? r[colHosp] : '').trim(),
          task,
          priority: String(colPri >= 0 ? r[colPri] : '').trim() || 'Unknown',
          status: String(colStatus >= 0 ? r[colStatus] : '').trim() || 'Unknown',
          pct: isNaN(pct) ? 0 : pct,
          due: due || 'TBD',
          field: String(colField >= 0 ? r[colField] : '').trim(),
          techops: String(colTechops >= 0 ? r[colTechops] : '').trim(),
          update: String(colUpdate >= 0 ? r[colUpdate] : '').trim(),
          openQ: String(colOpenQ >= 0 ? r[colOpenQ] : '').trim(),
          ticket: String(colTicket >= 0 ? r[colTicket] : '').trim(),
          type: String(colType >= 0 ? r[colType] : '').trim(),
        });
      }

      if (parsed.length === 0) {
        status.textContent = '‚ùå No data rows found after the header. Check your spreadsheet format.';
        status.className = 'parse-status error';
        return;
      }

      pendingData = { rows: parsed, sheetName, fileName: file.name, total: parsed.length };
      status.textContent = `‚úÖ Found ${parsed.length} items across ${workbook.SheetNames.length} sheet(s) ‚Äî sheet "${sheetName}" loaded. Ready to apply!`;
      status.className = 'parse-status success';
      document.getElementById('confirmBtn').classList.add('ready');

    } catch(err) {
      status.textContent = `‚ùå Error parsing file: ${err.message}`;
      status.className = 'parse-status error';
    }
  };
  reader.readAsArrayBuffer(file);
}

function applyNewData() {
  if (!pendingData) return;

  // Update live data
  window.LIVE_DATA = pendingData.rows;
  window.LIVE_SHEET = pendingData.sheetName;
  window.LIVE_TOTAL = pendingData.total;

  // Update header tag
  document.getElementById('dataTag').textContent = `Sheet: ${pendingData.sheetName} ¬∑ ${pendingData.total} items`;

  // Rebuild DATA_SUMMARY from new data
  rebuildSummaryAndStats(pendingData.rows, pendingData.sheetName);

  // Reset all tabs so they re-render with new data
  briefingLoaded = false;
  workloadLoaded = false;
  todayLoaded = false;

  closeUploadModal();

  // Switch to chat and notify
  switchTab('chat');
  const today = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  addMessage('assistant', `<span class="section-head">üìÇ New spreadsheet loaded ‚Äî ${pendingData.fileName}</span>

I've parsed <strong>${pendingData.total} items</strong> from sheet <strong>"${pendingData.sheetName}"</strong> and refreshed all tabs with the latest data.

${buildQuickSummary(pendingData.rows)}

All tabs (Briefing, Workload, Tackle Today) have been reset and will regenerate from your new data. Ask me anything!`);

  pendingData = null;
}

function buildQuickSummary(rows) {
  const today = new Date();
  const excluded = ['closed','cancelled','completed'];
  const active = rows.filter(r => !excluded.includes((r.status||'').toLowerCase()) && !excluded.includes((r.priority||'').toLowerCase()));

  let asap = 0, overdue = 0, high = 0, inprog = 0, notStarted0 = 0;
  active.forEach(r => {
    const pri = (r.priority||'').toLowerCase();
    const stat = (r.status||'').toLowerCase();
    if (r.due === 'ASAP') asap++;
    else {
      const d = new Date(r.due);
      if (!isNaN(d) && d < today) overdue++;
    }
    if (pri === 'high') high++;
    if (stat.includes('in progress')) inprog++;
    if (pri === 'high' && stat.includes('not started')) notStarted0++;
  });

  return `Here's a quick snapshot of the new data:\n\n‚Ä¢ <strong>${asap}</strong> items marked ASAP\n‚Ä¢ <strong>${overdue}</strong> overdue items\n‚Ä¢ <strong>${high}</strong> High priority items active\n‚Ä¢ <strong>${inprog}</strong> currently In Progress\n‚Ä¢ <strong>${notStarted0}</strong> High priority items not yet started`;
}

function rebuildSummaryAndStats(rows, sheetName) {
  const today = new Date();
  const excluded = ['closed','cancelled','completed'];
  const active = rows.filter(r => !excluded.includes((r.status||'').toLowerCase()) && !excluded.includes((r.priority||'').toLowerCase()));

  // Rebuild sidebar stats
  let critical = 0, overdue = 0, inprog = 0, notStartedHigh = 0, onHold = 0, issues = 0;
  active.forEach(r => {
    const pri = (r.priority||'').toLowerCase();
    const stat = (r.status||'').toLowerCase();
    if (r.due === 'ASAP' || pri === 'high') {
      const d = new Date(r.due);
      if (r.due === 'ASAP' || (!isNaN(d) && d < today && pri === 'high')) critical++;
    }
    const d = new Date(r.due);
    if (!isNaN(d) && d < today && r.due !== 'ASAP') overdue++;
    if (stat.includes('in progress')) inprog++;
    if (pri === 'high' && stat.includes('not started')) notStartedHigh++;
    if (stat.includes('hold') || stat.includes('on hold')) onHold++;
    if ((r.type||'').toLowerCase() === 'issue') issues++;
  });

  const vals = document.querySelectorAll('.stat-mini-val');
  if (vals[0]) vals[0].textContent = critical;
  if (vals[1]) vals[1].textContent = overdue;
  if (vals[2]) vals[2].textContent = inprog;
  if (vals[3]) vals[3].textContent = notStartedHigh;
  if (vals[4]) vals[4].textContent = onHold;
  if (vals[5]) vals[5].textContent = issues;

  // Rebuild global DATA_SUMMARY string for Claude context
  const lines = [`WCTV SOFTWARE DEPLOYMENT SCHEDULE ‚Äî As of ${new Date().toLocaleDateString()}`, `Sheet: ${sheetName} | Total items: ${rows.length}`, ''];
  const asapItems = active.filter(r => r.due === 'ASAP');
  const overdueItems = active.filter(r => { const d = new Date(r.due); return !isNaN(d) && d < today; });
  const soon = active.filter(r => { const d = new Date(r.due); return !isNaN(d) && d >= today && (d - today) / 86400000 <= 14; });

  lines.push('ASAP ITEMS:');
  asapItems.slice(0,5).forEach(r => lines.push(`- ${r.task} (${r.hospital || r.idn}) [${r.priority}] ‚Äî ${r.techops}`));
  lines.push('');
  lines.push('OVERDUE ITEMS:');
  overdueItems.slice(0,10).forEach(r => { const d = new Date(r.due); lines.push(`- ${r.task} (${r.hospital || r.idn}) ‚Äî Due: ${r.due} ‚Äî Status: ${r.status} ‚Äî ${r.techops}`); });
  lines.push('');
  lines.push('DUE WITHIN 14 DAYS:');
  soon.slice(0,10).forEach(r => lines.push(`- ${r.task} (${r.hospital || r.idn}) ‚Äî Due: ${r.due} ‚Äî ${r.priority} ‚Äî ${r.pct}% done`));
  lines.push('');
  lines.push('HIGH PRIORITY NOT STARTED:');
  active.filter(r => r.priority.toLowerCase() === 'high' && r.status.toLowerCase().includes('not started')).forEach(r => lines.push(`- ${r.task} (${r.hospital || r.idn}) ‚Äî Due: ${r.due}`));
  lines.push('');
  lines.push('OPEN QUESTIONS:');
  active.filter(r => r.openQ && r.openQ.length > 3).slice(0,10).forEach(r => lines.push(`- [${r.hospital || r.idn}] ${r.openQ}`));

  // Store for Claude
  window.DYNAMIC_SUMMARY = lines.join('\n');
  window.DYNAMIC_DATA = active;
}

// Override callClaude to use dynamic summary when available
const _origCallClaude = callClaude;
async function callClaude(userMessage) {
  const summaryToUse = window.DYNAMIC_SUMMARY || DATA_SUMMARY;
  const systemPrompt = `You are an intelligent deployment schedule analyzer for WCTV, a software deployment company serving hospitals. You have full access to the current deployment schedule data below.

Your job is to help the team understand priorities, identify blockers, answer questions about specific projects, analyze workloads, and suggest what to work on next.

Be concise but thorough. Use bold text for important items, names, and deadlines. When listing items, be specific ‚Äî include the hospital name, job number if relevant, and who is assigned.

DEPLOYMENT DATA:
${summaryToUse}

Today's date is ${new Date().toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'})}. Q1 2026 ends March 31, 2026.

When answering about priorities, focus on: 1) overdue items, 2) ASAP items, 3) due dates within 14 days, 4) High priority items with 0% progress, 5) open questions blocking progress.`;

  conversationHistory.push({ role: "user", content: userMessage });

  const response = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      model: "claude-sonnet-4-20250514",
      max_tokens: 1000,
      system: systemPrompt,
      messages: conversationHistory
    })
  });

  const data = await response.json();
  const reply = data.content?.[0]?.text || "Sorry, I couldn't process that request.";
  conversationHistory.push({ role: "assistant", content: reply });
  return reply;
}

// Close modal on overlay click
document.getElementById('uploadModal').addEventListener('click', function(e) {
  if (e.target === this) closeUploadModal();
});
</script>
</body>
</html>
